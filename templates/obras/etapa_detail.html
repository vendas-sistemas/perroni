{% extends 'base.html' %}

{% block title %}Etapa {{ etapa.numero_etapa }} - {{ etapa.obra.nome }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  .detail-card { border: none; border-radius: .75rem; }
  .detail-header { border-radius: .75rem .75rem 0 0; padding: .6rem 1rem; }
  .detail-item { padding: .5rem 0; border-bottom: 1px solid #f0f0f0; }
  .detail-item:last-child { border-bottom: none; }
  .detail-item .label { font-size: .82rem; color: #6c757d; font-weight: 600; }
  .detail-item .value { font-weight: 500; }
  .etapa-number-lg {
    width: 56px; height: 56px;
    border-radius: .75rem;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; font-weight: 700;
  }
  .progress-lg { height: 10px; border-radius: 5px; }
</style>
{% endblock %}

{% block content %}

<!-- Header -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <div class="d-flex align-items-center gap-3">
    <div class="etapa-number-lg {% if etapa.concluida %}bg-success text-white{% else %}bg-primary bg-opacity-10 text-primary{% endif %}">
      {% if etapa.concluida %}<i class="bi bi-check-lg"></i>{% else %}{{ etapa.numero_etapa }}{% endif %}
    </div>
    <div>
      <h1 class="h3 mb-0">
        {% if etapa.numero_etapa == 1 %}<i class="bi bi-bricks text-primary"></i> Fundação
        {% elif etapa.numero_etapa == 2 %}<i class="bi bi-building-up text-primary"></i> Estrutura
        {% elif etapa.numero_etapa == 3 %}<i class="bi bi-plug text-primary"></i> Revestimentos e Instalações
        {% elif etapa.numero_etapa == 4 %}<i class="bi bi-paint-bucket text-primary"></i> Acabamentos
        {% elif etapa.numero_etapa == 5 %}<i class="bi bi-flag text-primary"></i> Finalização
        {% endif %}
      </h1>
      <div class="text-muted small">
        <i class="bi bi-building"></i> {{ etapa.obra.nome }}
        {% if etapa.obra.cliente %}<span class="ms-2"><i class="bi bi-person"></i> {{ etapa.obra.cliente.nome }}</span>{% endif %}
      </div>
    </div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'obras:obra_etapas' etapa.obra.pk %}" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>
</div>

<div class="row g-3">
  <!-- Left: Info geral -->
  <div class="col-lg-6">
    <div class="card detail-card shadow-sm">
      <div class="detail-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 text-primary"><i class="bi bi-info-circle"></i> Informações Gerais</h6>
        <a href="{% url 'obras:etapa_edit' etapa.pk %}" class="btn btn-primary btn-sm d-flex align-items-center gap-1 px-3">
          <i class="bi bi-pencil-square"></i> Editar
        </a>
      </div>
      <div class="card-body">
        <div class="detail-item d-flex justify-content-between">
          <span class="label"><i class="bi bi-layers"></i> Etapa</span>
          <span class="value">{{ etapa.get_numero_etapa_display }}</span>
        </div>
        <div class="detail-item d-flex justify-content-between">
          <span class="label"><i class="bi bi-percent"></i> Percentual</span>
          <span class="value fw-bold">{{ etapa.percentual_valor }}%</span>
        </div>
        <div class="detail-item d-flex justify-content-between">
          <span class="label"><i class="bi bi-calendar-event"></i> Data Início</span>
          <span class="value">{% if etapa.data_inicio %}{{ etapa.data_inicio|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
        </div>
        <div class="detail-item d-flex justify-content-between">
          <span class="label"><i class="bi bi-calendar-check"></i> Data Término</span>
          <span class="value">{% if etapa.data_termino %}{{ etapa.data_termino|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
        </div>
        <div class="detail-item d-flex justify-content-between">
          <span class="label"><i class="bi bi-check-circle"></i> Status</span>
          <span class="value">
            {% if etapa.status == 'concluida' %}
              <span class="badge bg-success"><i class="bi bi-check-lg"></i> Concluída</span>
            {% elif etapa.status == 'em_andamento' %}
              <span class="badge bg-primary"><i class="bi bi-play-circle"></i> Em andamento</span>
            {% else %}
              <span class="badge bg-secondary">Pendente</span>
            {% endif %}
          </span>
        </div>
        <!-- Progress bar -->
        <div class="mt-3">
          <div class="progress progress-lg">
            <div class="progress-bar {% if etapa.status == 'concluida' %}bg-success{% elif etapa.status == 'em_andamento' %}bg-primary{% else %}bg-secondary opacity-25{% endif %}"
                 style="width: {% if etapa.status == 'concluida' %}100{% elif etapa.status == 'em_andamento' %}50{% else %}5{% endif %}%;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Detalhes -->
  <div class="col-lg-6">
    {% if detalhe %}
    <div class="card detail-card shadow-sm">
      <div class="detail-header" style="background: rgba(25,135,84,.1);">
        <h6 class="mb-0 text-success"><i class="bi bi-clipboard-data"></i> Detalhes Específicos</h6>
      </div>
      <div class="card-body">
        {% if etapa.numero_etapa == 1 %}
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Limpeza do Terreno</span>
            <span>{% if detalhe.limpeza_terreno %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Instalação Energia/Água</span>
            <span>{% if detalhe.instalacao_energia_agua %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Marcação/Escavação</span>
            <span class="value">{% if detalhe.marcacao_escavacao_conclusao %}{{ detalhe.marcacao_escavacao_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Locação Ferragem</span>
            <span class="value">{% if detalhe.locacao_ferragem_conclusao %}{{ detalhe.locacao_ferragem_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Aterro e Contrapiso</span>
            <span class="value">{% if detalhe.aterro_contrapiso_conclusao %}{{ detalhe.aterro_contrapiso_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">8 Fiadas até Respaldo</span>
            <span class="value">{% if detalhe.fiadas_respaldo_conclusao %}{{ detalhe.fiadas_respaldo_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
        {% elif etapa.numero_etapa == 2 %}
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Montagem da Laje</span>
            <span class="value">{% if detalhe.montagem_laje_conclusao %}{{ detalhe.montagem_laje_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Cobertura</span>
            <span class="value">{% if detalhe.cobertura_conclusao %}{{ detalhe.cobertura_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
        {% elif etapa.numero_etapa == 3 %}
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Reboco Externo</span>
            <span class="value">{{ detalhe.reboco_externo_m2 }} m²</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Reboco Interno</span>
            <span class="value">{{ detalhe.reboco_interno_m2 }} m²</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Instalação Portais</span>
            <span>{% if detalhe.instalacao_portais %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Água Fria</span>
            <span>{% if detalhe.agua_fria %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Esgoto</span>
            <span>{% if detalhe.esgoto %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Fluvial</span>
            <span>{% if detalhe.fluvial %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
        {% elif etapa.numero_etapa == 4 %}
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Portas e Janelas</span>
            <span>{% if detalhe.portas_janelas %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Pintura Externa 1ª Demão</span>
            <span class="value">{% if detalhe.pintura_externa_1demao_conclusao %}{{ detalhe.pintura_externa_1demao_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Pintura Interna 1ª Demão</span>
            <span class="value">{% if detalhe.pintura_interna_1demao_conclusao %}{{ detalhe.pintura_interna_1demao_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Assentamento de Piso</span>
            <span class="value">{% if detalhe.assentamento_piso_conclusao %}{{ detalhe.assentamento_piso_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
        {% elif etapa.numero_etapa == 5 %}
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Pintura Externa 2ª Demão</span>
            <span class="value">{% if detalhe.pintura_externa_2demao_conclusao %}{{ detalhe.pintura_externa_2demao_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Pintura Interna 2ª Demão</span>
            <span class="value">{% if detalhe.pintura_interna_2demao_conclusao %}{{ detalhe.pintura_interna_2demao_conclusao|date:"d/m/Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Louças e Metais</span>
            <span>{% if detalhe.loucas_metais %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
          <div class="detail-item d-flex justify-content-between">
            <span class="label">Elétrica</span>
            <span>{% if detalhe.eletrica %}<span class="text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>{% else %}<span class="text-danger"><i class="bi bi-x-circle"></i> Não</span>{% endif %}</span>
          </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <div class="card detail-card shadow-sm">
      <div class="card-body text-center py-5">
        <i class="bi bi-clipboard-plus fs-1 text-muted"></i>
        <p class="mt-2 mb-3 text-muted">Detalhes desta etapa ainda não foram preenchidos.</p>
        {% if etapa.numero_etapa == 1 %}
          <a href="{% url 'obras:etapa1_detail' etapa.pk %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Preencher agora</a>
        {% elif etapa.numero_etapa == 2 %}
          <a href="{% url 'obras:etapa2_detail' etapa.pk %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Preencher agora</a>
        {% elif etapa.numero_etapa == 3 %}
          <a href="{% url 'obras:etapa3_detail' etapa.pk %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Preencher agora</a>
        {% elif etapa.numero_etapa == 4 %}
          <a href="{% url 'obras:etapa4_detail' etapa.pk %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Preencher agora</a>
        {% elif etapa.numero_etapa == 5 %}
          <a href="{% url 'obras:etapa5_detail' etapa.pk %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Preencher agora</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<div class="card detail-card shadow-sm mt-3">
  <div class="detail-header" style="background: rgba(13,110,253,.1);">
    <h6 class="mb-0 text-primary"><i class="bi bi-clock-history"></i> Histórico da Etapa</h6>
  </div>
  <div class="card-body">
    {% if historicos %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width: 170px;">Data e Hora</th>
              <th style="width: 240px;">Origem</th>
              <th>Alterações</th>
              <th style="width: 180px;">Usuário</th>
            </tr>
          </thead>
          <tbody>
            {% for h in historicos %}
              <tr>
                <td>{{ h.data_hora|date:"d/m/Y H:i" }}</td>
                <td>
                  {% if 'Apontamento' in h.origem %}
                    <span class="badge bg-info text-dark"><i class="bi bi-clipboard-check"></i> {{ h.origem }}</span>
                  {% elif 'Criação' in h.origem %}
                    <span class="badge bg-success"><i class="bi bi-plus-circle"></i> {{ h.origem }}</span>
                  {% else %}
                    {{ h.origem }}
                  {% endif %}
                </td>
                <td><pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ h.descricao }}</pre></td>
                <td>{% if h.usuario %}{{ h.usuario.get_full_name|default:h.usuario.username }}{% else %}<span class="text-muted">Sistema</span>{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Nenhum histórico registrado para esta etapa.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
