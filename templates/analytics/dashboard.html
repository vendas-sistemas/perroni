{% extends 'base.html' %}

{% block title %}Dashboard - Analytics{% endblock %}

{% block extra_css %}
<style>
  .metric-card { border-left: 4px solid rgba(0,0,0,0.06); }
  .brand-dark { background-color: #0b5ed7; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dashboard</h2>
    <small class="text-muted">Visão geral — métricas e obras em andamento</small>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-md-3">
      <div class="card metric-card shadow-sm">
        <div class="card-body">
          <h6 class="text-uppercase text-muted">Total Obras</h6>
          <h3 class="mt-2">{{ metrics.total_obras|default:0 }}</h3>
          <small class="text-muted">Obras cadastradas</small>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-3">
      <div class="card metric-card shadow-sm">
        <div class="card-body">
          <h6 class="text-uppercase text-muted">Em Andamento</h6>
          <h3 class="mt-2 text-primary">{{ metrics.obras_em_andamento|default:0 }}</h3>
          <small class="text-muted">Obras ativas</small>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-3">
      <div class="card metric-card shadow-sm">
        <div class="card-body">
          <h6 class="text-uppercase text-muted">Clientes</h6>
          <h3 class="mt-2">{{ metrics.total_clientes|default:0 }}</h3>
          <small class="text-muted">Clientes cadastrados</small>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-3">
      <div class="card brand-dark shadow-sm">
        <div class="card-body">
          <h6 class="text-uppercase text-light">Média Conclusão</h6>
          <h3 class="mt-2">{{ metrics.avg_percentual|default:"0.00" }}%</h3>
          <small class="text-light">Percentual médio de progresso</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Progresso das Obras</h5>
            <small class="text-muted">Últimos 12 meses</small>
          </div>
          <canvas id="obrasChart" height="220"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Obras em andamento</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Obra</th>
                  <th>Cliente</th>
                  <th class="text-end">%</th>
                </tr>
              </thead>
              <tbody>
                {% for obra in obras_em_andamento %}
                <tr>
                  <td><a href="{% url 'obras:obra_detail' obra.pk %}">{{ obra.nome }}</a></td>
                  <td>{{ obra.cliente }}</td>
                  <td class="text-end">{{ obra.percentual_concluido }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted">Nenhuma obra em andamento.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  (function(){
    const labels = {{ chart_labels|default:'[]'|safe }};
    const data = {{ chart_values|default:'[]'|safe }};

    const ctx = document.getElementById('obrasChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Percentual Médio',
            data: data,
            fill: true,
            backgroundColor: 'rgba(11,94,215,0.12)',
            borderColor: '#0b5ed7',
            tension: 0.3,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });
    }
  })();
</script>
{% endblock %}
