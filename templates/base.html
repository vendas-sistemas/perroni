<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Fiscalização de Obras{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    {% block extra_css %}{% endblock %}
    <style>
      :root {
        --nav-gradient-start: #1a237e;
        --nav-gradient-end: #283593;
        --nav-hover: rgba(255,255,255,.12);
        --nav-active: rgba(255,255,255,.2);
        --accent: #42a5f5;
      }

      /* ─── Navbar ─── */
      .main-navbar {
        background: linear-gradient(135deg, var(--nav-gradient-start), var(--nav-gradient-end));
        box-shadow: 0 2px 12px rgba(0,0,0,.25);
        padding: .35rem 0;
      }
      .main-navbar .nav-link {
        color: rgba(255,255,255,.85);
        padding: .6rem .9rem;
        border-radius: .5rem;
        font-size: .875rem;
        font-weight: 500;
        transition: all .2s;
        display: flex;
        align-items: center;
        gap: .4rem;
      }
      .main-navbar .nav-link:hover,
      .main-navbar .nav-link:focus {
        color: #fff;
        background: var(--nav-hover);
      }
      .main-navbar .nav-link.active,
      .main-navbar .nav-link-active {
        color: #fff;
        background: var(--nav-active);
      }
      .main-navbar .nav-link .bi { font-size: 1.05rem; }
      .navbar-brand-custom {
        color: #fff !important;
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: .5rem;
        text-decoration: none;
        padding: .3rem 0;
      }
      .navbar-brand-custom .brand-icon {
        background: rgba(255,255,255,.15);
        border-radius: .5rem;
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
      }
      .navbar-brand-custom:hover .brand-icon {
        background: rgba(255,255,255,.25);
      }

      /* Dropdown */
      .main-navbar .dropdown-menu {
        border: none;
        border-radius: .75rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.15);
        padding: .5rem;
        min-width: 230px;
        animation: dropIn .2s ease;
      }
      @keyframes dropIn {
        from { opacity: 0; transform: translateY(-6px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      .main-navbar .dropdown-item {
        border-radius: .5rem;
        padding: .5rem .75rem;
        font-size: .875rem;
        display: flex;
        align-items: center;
        gap: .5rem;
        transition: background .15s;
      }
      .main-navbar .dropdown-item:hover {
        background: #e8eaf6;
      }
      .main-navbar .dropdown-item .bi { font-size: 1rem; width: 20px; text-align: center; }
      .dropdown-section-label {
        font-size: .7rem;
        font-weight: 700;
        letter-spacing: .06em;
        color: #9e9e9e;
        text-transform: uppercase;
        padding: .4rem .75rem .2rem;
      }

      /* User pill */
      .user-pill {
        background: rgba(255,255,255,.12);
        border-radius: 2rem;
        padding: .35rem .75rem .35rem .5rem;
        display: flex;
        align-items: center;
        gap: .45rem;
        color: rgba(255,255,255,.9);
        font-size: .82rem;
        font-weight: 500;
        white-space: nowrap;
      }
      .user-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: .75rem;
        color: #fff;
      }

      /* Logout btn */
      .btn-logout {
        color: rgba(255,255,255,.7);
        border: 1px solid rgba(255,255,255,.2);
        border-radius: .5rem;
        padding: .35rem .65rem;
        font-size: .82rem;
        text-decoration: none;
        background: transparent;
        transition: all .2s;
        display: flex;
        align-items: center;
        gap: .3rem;
      }
      .btn-logout:hover {
        color: #fff;
        background: rgba(255,255,255,.1);
        border-color: rgba(255,255,255,.35);
      }

      /* ─── Offcanvas Mobile ─── */
      .offcanvas-nav {
        background: linear-gradient(180deg, var(--nav-gradient-start), var(--nav-gradient-end));
        max-width: 280px;
      }
      .offcanvas-nav .offcanvas-header {
        border-bottom: 1px solid rgba(255,255,255,.1);
      }
      .offcanvas-nav .btn-close {
        filter: invert(1);
      }
      .offcanvas-nav .nav-link {
        color: rgba(255,255,255,.85);
        padding: .65rem 1rem;
        border-radius: .5rem;
        font-size: .9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: .5rem;
        transition: all .15s;
      }
      .offcanvas-nav .nav-link:hover,
      .offcanvas-nav .nav-link.active {
        color: #fff;
        background: rgba(255,255,255,.12);
      }
      .offcanvas-nav .dropdown-menu {
        background: rgba(255,255,255,.08);
        border: none;
        border-radius: .5rem;
        margin: .25rem 0;
        padding: .3rem;
      }
      .offcanvas-nav .dropdown-item {
        color: rgba(255,255,255,.8);
        border-radius: .4rem;
        font-size: .85rem;
        padding: .45rem .75rem;
        display: flex;
        align-items: center;
        gap: .5rem;
      }
      .offcanvas-nav .dropdown-item:hover {
        color: #fff;
        background: rgba(255,255,255,.12);
      }
      .offcanvas-nav .dropdown-section-label {
        color: rgba(255,255,255,.4);
      }
      .offcanvas-nav .dropdown-divider {
        border-color: rgba(255,255,255,.1);
      }
      .offcanvas-divider {
        border-color: rgba(255,255,255,.1);
        margin: .5rem 1rem;
      }

      /* ─── Messages ─── */
      .alert-toast {
        border: none;
        border-radius: .75rem;
        box-shadow: 0 2px 12px rgba(0,0,0,.08);
        font-size: .9rem;
      }

      /* ─── Footer ─── */
      .main-footer {
        border-top: 1px solid #dee2e6;
        padding: 1rem 0;
        margin-top: 2rem;
        font-size: .78rem;
        color: #9e9e9e;
      }

      /* ─── Global helpers ─── */
      body { min-height: 100vh; display: flex; flex-direction: column; }
      main  { flex: 1; }
      /* Dark theme variables when body has .theme-dark (lighter/duller tone) */
      body.theme-dark {
        --nav-gradient-start: #0f2a44;
        --nav-gradient-end: #123a5c;
        --nav-hover: rgba(255,255,255,.06);
        --nav-active: rgba(255,255,255,.10);
        --accent: #82bfff;
        background-color: #0d2233 !important;
        color: #e6f0fb !important;
      }
      body.theme-dark .main-navbar .nav-link:hover,
      body.theme-dark .main-navbar .nav-link:focus { background: rgba(255,255,255,.05); }
      body.theme-dark .main-navbar .dropdown-item:hover { background: rgba(255,255,255,.04); }
      body.theme-dark .user-pill { background: rgba(255,255,255,.08); color: #eaf4ff; }
      body.theme-dark .main-footer { background: transparent; color: #b6d0e8; }
      body.theme-dark .card { background-color: rgba(255,255,255,.06); color: #eaf4ff; border-color: rgba(255,255,255,.07); }
      body.theme-dark table.table-striped tbody tr:nth-of-type(odd) { background-color: rgba(255,255,255,.04); }
      body.theme-dark .table thead { background: rgba(255,255,255,.06); color: #d8e9fb; }
      body.theme-dark .badge.bg-success { background-color: #198754 !important; }
      body.theme-dark .badge.bg-warning { background-color: #ffc107 !important; color: #222 !important; }
      body.theme-dark .badge.bg-danger { background-color: #dc3545 !important; }
      body.theme-dark .alert { background-color: rgba(255,255,255,.05); color: #eaf4ff; border-color: rgba(255,255,255,.07); }
      body.theme-dark .btn-outline-secondary { color: #e0efff; border-color: rgba(255,255,255,.08); }
      body.theme-dark .btn-outline-light { color: #e0efff; border-color: rgba(255,255,255,.08); }

      /* Variant: soft - slightly warmer, reduced contrast */
      body.theme-dark.variant-soft {
        --nav-gradient-start: #163244;
        --nav-gradient-end: #1b4161;
        --accent: #95c8ff;
        background-color: #112733 !important;
      }
      body.theme-dark.variant-soft .card { background-color: rgba(255,255,255,.07); }

      /* Variant: gray - desaturated, neutral grays */
      body.theme-dark.variant-gray {
        --nav-gradient-start: #2b2f33;
        --nav-gradient-end: #1f2428;
        --accent: #a8b3bf;
        background-color: #16181a !important;
      }
      body.theme-dark.variant-gray .card { background-color: rgba(255,255,255,.04); }

      /* Variant: blue - stronger blue accents */
      body.theme-dark.variant-blue {
        --nav-gradient-start: #08304b;
        --nav-gradient-end: #0b4670;
        --accent: #7cc0ff;
        background-color: #071b2a !important;
      }
      body.theme-dark.variant-blue .card { background-color: rgba(255,255,255,.05); }

      /* Dashboard summary tuning for better legibility */
      .dashboard-summary .card { border-radius: .6rem; border: 1px solid rgba(0,0,0,.06); }
      .dashboard-summary .card .small { color: rgba(255,255,255,.65); }
      .dashboard-summary .card .h5 { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
      .dashboard-summary .card .text-muted { color: rgba(255,255,255,.55); }

      /* Variants: tune dashboard card borders/background/text/badge saturation */
      body.theme-dark.variant-soft .dashboard-summary .card { background-color: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08); }
      body.theme-dark.variant-soft .dashboard-summary .card .h5 { color: #bfe6ff; }
      body.theme-dark.variant-soft .badge { opacity: 0.95; }

      body.theme-dark.variant-gray .dashboard-summary .card { background-color: rgba(255,255,255,.045); border-color: rgba(255,255,255,.06); }
      body.theme-dark.variant-gray .dashboard-summary .card .h5 { color: #dbe6ef; }
      body.theme-dark.variant-gray .badge { filter: grayscale(.15) saturate(.7); }

      body.theme-dark.variant-blue .dashboard-summary .card { background-color: rgba(10,40,60,.065); border-color: rgba(120,180,255,.06); }
      body.theme-dark.variant-blue .dashboard-summary .card .h5 { color: #9fd6ff; }
      body.theme-dark.variant-blue .badge { box-shadow: 0 0 10px rgba(124,192,255,.06); }

      /* Mobile fixes: avoid native select/arrow overlapping text */
      @media (max-width: 575.98px) {
        .form-control, input.form-control, select.form-control, .input-group .form-control {
          padding-right: 2.6rem !important;
        }
        select.form-control {
          -webkit-appearance: menulist-button;
          appearance: menulist-button;
        }
        /* make offcanvas nav items wrap instead of overlapping */
        .offcanvas-nav .nav-link { white-space: normal; }
        /* style collapsed menus as expandable items inside offcanvas */
        .offcanvas-nav .collapse {
          background: rgba(255,255,255,0.04);
          border-radius: .4rem;
          margin: .2rem 0;
          overflow: hidden;
          transition: all .2s ease;
        }
        .offcanvas-nav .collapse.show {
          background: rgba(255,255,255,0.08);
        }
        .offcanvas-nav .collapse .dropdown-item {
          border-radius: 0;
          padding-left: 1.5rem;
        }
        .offcanvas-nav [data-bs-toggle="collapse"] {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .offcanvas-nav [data-bs-toggle="collapse"]::after {
          content: '';
          display: inline-block;
          width: 0.5rem;
          height: 0.5rem;
          border-right: 2px solid rgba(255,255,255,.6);
          border-bottom: 2px solid rgba(255,255,255,.6);
          transform: rotate(-45deg);
          margin-left: auto;
          transition: transform .2s;
        }
        .offcanvas-nav [data-bs-toggle="collapse"][aria-expanded="true"]::after {
          transform: rotate(45deg);
        }
      }
    </style>
  </head>
  <body class="bg-light" {% if user.is_authenticated %}data-server-theme="{{ request.user.profile.theme_preference }}" data-server-variant="{{ request.user.profile.theme_variant }}"{% endif %}>
    {% url 'login' as login_url %}

    {# ═══════ DESKTOP NAVBAR (lg+) ═══════ #}
    <nav class="main-navbar navbar navbar-expand-lg d-none d-lg-flex">
      <div class="container-fluid px-3">
        <!-- Brand -->
        <a class="navbar-brand-custom me-3" href="{% if user.is_authenticated %}{% url 'home' %}{% else %}/{% endif %}">
          <span class="brand-icon"><i class="bi bi-building-gear"></i></span>
          <span>Fiscalização</span>
        </a>

        {% if user.is_authenticated %}
        <!-- Main links -->
        <ul class="navbar-nav me-auto gap-1">
          {% if nav_perms.obras %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'obras:obra_list' %}">
              <i class="bi bi-buildings"></i> Obras
            </a>
          </li>
          {% endif %}
          <!-- Fiscalização removida em 21/02/2026 -->

          <!-- Funcionários -->
          {% if nav_perms.funcionarios %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-people"></i> Funcionários
            </a>
            <ul class="dropdown-menu">
              <li class="dropdown-section-label">Cadastro</li>
              <li><a class="dropdown-item" href="/funcionarios/"><i class="bi bi-person-lines-fill text-primary"></i> Lista de Funcionários</a></li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-section-label">Apontamentos</li>
              <!-- Registro Diário removido em 21/02/2026: usar Fiscalizar Obras -->
              <li><a class="dropdown-item" href="{% url 'funcionarios:apontamento_lote_create' %}"><i class="bi bi-person-plus-fill text-info"></i> Fiscalizar Obras</a></li>
              <li><a class="dropdown-item" href="{% url 'funcionarios:apontamento_lote_list' %}"><i class="bi bi-list-ul text-info"></i> Ver Obras Fiscalizadas</a></li>
              <li><a class="dropdown-item" href="/funcionarios/apontamentos/"><i class="bi bi-list-check text-muted"></i> Todos as dárias</a></li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-section-label">Fechamentos</li>
              <li><a class="dropdown-item" href="/funcionarios/fechamentos/"><i class="bi bi-calculator text-muted"></i> Fechamentos Semanais</a></li>
              <li><a class="dropdown-item" href="/funcionarios/fechamentos/auto/"><i class="bi bi-lightning-charge text-warning"></i> <strong>Fechamento Automático</strong></a></li>
            </ul>
          </li>
          {% endif %}

          {% if nav_perms.ferramentas %}
          <li class="nav-item">
            <a class="nav-link" href="/ferramentas/">
              <i class="bi bi-tools"></i> Ferramentas
            </a>
          </li>
          {% endif %}

          {% if nav_perms.analytics %}
          <li class="nav-item">
            <a class="nav-link" href="/analytics/">
              <i class="bi bi-graph-up"></i> Analytics
            </a>
          </li>
          {% endif %}

          {% if nav_perms.relatorios %}
          <li class="nav-item">
            <a class="nav-link" href="/relatorios/">
              <i class="bi bi-bar-chart-line"></i> Relatórios
            </a>
          </li>
          {% endif %}

          <!-- Clientes -->
          {% if nav_perms.clientes %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-vcard"></i> Clientes
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'clientes:cliente_list' %}"><i class="bi bi-people text-primary"></i> Lista de Clientes</a></li>
              <li><a class="dropdown-item" href="{% url 'clientes:cliente_create' %}"><i class="bi bi-person-plus text-success"></i> Cadastrar Cliente</a></li>
            </ul>
          </li>
          {% endif %}
        </ul>

        <!-- Right side -->
        <div class="d-flex align-items-center gap-2">
          <button id="themeToggle" type="button" class="btn btn-sm btn-outline-light" title="Alternar tema (claro/escuro)">
            <i id="themeToggleIcon" class="bi bi-moon-fill"></i>
          </button>
          <!-- Theme selector popover -->
          <div id="themePopover" class="card p-2" style="position:absolute; right:16px; top:56px; width:220px; display:none; z-index:1200;">
            <div class="mb-2"><strong>Tema</strong></div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="site-theme" id="themeLight" value="light">
              <label class="form-check-label" for="themeLight">Claro</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="site-theme" id="themeDark" value="dark">
              <label class="form-check-label" for="themeDark">Escuro</label>
            </div>
            <hr class="my-2">
            <div class="mb-1"><strong>Variante (escuro)</strong></div>
            <select id="themeVariantSelect" class="form-select form-select-sm">
              <option value="default">Padrão</option>
              <option value="soft">Suave</option>
              <option value="gray">Cinza</option>
              <option value="blue">Azulado</option>
            </select>
            <div class="d-flex gap-2 mt-2 mb-1" style="flex-wrap:wrap;">
              <button type="button" class="btn p-1 palette-swatch" data-variant="default" title="Padrão" style="width:36px;height:28px;border:1px solid rgba(0,0,0,.08);background:linear-gradient(90deg,#0f2a44,#123a5c);"></button>
              <button type="button" class="btn p-1 palette-swatch" data-variant="soft" title="Suave" style="width:36px;height:28px;border:1px solid rgba(0,0,0,.08);background:linear-gradient(90deg,#163244,#1b4161);"></button>
              <button type="button" class="btn p-1 palette-swatch" data-variant="gray" title="Cinza" style="width:36px;height:28px;border:1px solid rgba(0,0,0,.08);background:linear-gradient(90deg,#2b2f33,#1f2428);"></button>
              <button type="button" class="btn p-1 palette-swatch" data-variant="blue" title="Azulado" style="width:36px;height:28px;border:1px solid rgba(0,0,0,.08);background:linear-gradient(90deg,#08304b,#0b4670);"></button>
            </div>
            <div class="d-flex justify-content-end mt-2">
              <button id="themeApplyBtn" class="btn btn-sm btn-primary">Aplicar</button>
            </div>
          </div>
          {% if nav_perms.admin %}
          <a href="/admin/" class="nav-link py-1 px-2" title="Admin" style="color:rgba(255,255,255,.7);">
            <i class="bi bi-gear"></i>
          </a>
          {% endif %}
          <div class="user-pill">
            <span class="user-avatar">{{ user.first_name|default:user.username|truncatechars:1|upper }}</span>
            {{ user.get_full_name|default:user.username }}
          </div>
          <form method="post" action="{% url 'logout' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn-logout" title="Sair">
              <i class="bi bi-box-arrow-right"></i>
            </button>
          </form>
        </div>
        {% else %}
        {% if request.path != login_url %}
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}"><i class="bi bi-box-arrow-in-right"></i> Login</a>
          </li>
        </ul>
        {% endif %}
        {% endif %}
      </div>
    </nav>

    {# ═══════ MOBILE TOP BAR + OFFCANVAS (< lg) ═══════ #}
    <nav class="main-navbar navbar d-lg-none">
      <div class="container-fluid px-3">
        <a class="navbar-brand-custom" href="{% if user.is_authenticated %}{% url 'home' %}{% else %}/{% endif %}">
          <span class="brand-icon"><i class="bi bi-building-gear"></i></span>
          <span>Fiscalização</span>
        </a>
        {% if user.is_authenticated %}
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-label="Menu">
          <span class="navbar-toggler-icon"></span>
        </button>
        {% endif %}
      </div>
    </nav>

    {% if user.is_authenticated %}
    <div class="offcanvas offcanvas-start offcanvas-nav d-lg-none" tabindex="-1" id="mobileNav">
      <div class="offcanvas-header pb-2">
        <div class="d-flex align-items-center gap-2">
          <span class="user-avatar">{{ user.first_name|default:user.username|truncatechars:1|upper }}</span>
          <div>
            <div class="text-white fw-semibold" style="font-size:.9rem;">{{ user.get_full_name|default:user.username }}</div>
            <div style="font-size:.75rem;color:rgba(255,255,255,.5);">{{ user.email|default:"" }}</div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>
      <div class="offcanvas-body p-2">
        <ul class="navbar-nav gap-1">
          {% if nav_perms.obras %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'obras:obra_list' %}"><i class="bi bi-buildings"></i> Obras</a>
          </li>
          {% endif %}
          <!-- Fiscalização removida em 21/02/2026 -->

          {% if nav_perms.funcionarios %}
          <hr class="offcanvas-divider">

          <!-- Funcionários -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-people"></i> Funcionários
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/funcionarios/"><i class="bi bi-person-lines-fill"></i> Lista</a></li>
              <li><hr class="dropdown-divider"></li>
              <!-- Registro Diário removido em 21/02/2026: usar Apontamento em Lote -->
              <li><a class="dropdown-item" href="{% url 'funcionarios:apontamento_lote_create' %}"><i class="bi bi-person-plus-fill"></i> Apontamento em Lote</a></li>
              <li><a class="dropdown-item" href="{% url 'funcionarios:apontamento_lote_list' %}"><i class="bi bi-list-ul"></i> Ver Apontamentos em Lote</a></li>
              <li><a class="dropdown-item" href="/funcionarios/apontamentos/"><i class="bi bi-list-check"></i> Todos as dárias</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><button id="themeToggleMobile" class="dropdown-item" type="button"><i class="bi bi-moon-fill"></i> Tema Escuro</button></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/funcionarios/fechamentos/"><i class="bi bi-calculator"></i> Fechamentos</a></li>
              <li><a class="dropdown-item" href="/funcionarios/fechamentos/auto/"><i class="bi bi-lightning-charge"></i> <strong>Fech. Automático</strong></a></li>
            </ul>
          </li>
          {% endif %}

          {% if nav_perms.ferramentas %}
          <li class="nav-item">
            <a class="nav-link" href="/ferramentas/"><i class="bi bi-tools"></i> Ferramentas</a>
          </li>
          {% endif %}
          {% if nav_perms.analytics %}
          <li class="nav-item">
            <a class="nav-link" href="/analytics/"><i class="bi bi-graph-up"></i> Analytics</a>
          </li>
          {% endif %}
          {% if nav_perms.relatorios %}
          <li class="nav-item">
            <a class="nav-link" href="/relatorios/"><i class="bi bi-bar-chart-line"></i> Relatórios</a>
          </li>
          {% endif %}

          {% if nav_perms.clientes %}
          <hr class="offcanvas-divider">

          <!-- Clientes -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-vcard"></i> Clientes
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'clientes:cliente_list' %}"><i class="bi bi-people"></i> Lista de Clientes</a></li>
              <li><a class="dropdown-item" href="{% url 'clientes:cliente_create' %}"><i class="bi bi-person-plus"></i> Cadastrar Cliente</a></li>
            </ul>
          </li>
          {% endif %}

          {% if nav_perms.admin %}
          <hr class="offcanvas-divider">

          <li class="nav-item">
            <a class="nav-link" href="/admin/"><i class="bi bi-gear"></i> Admin</a>
          </li>
          {% endif %}
          <li class="nav-item">
            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" class="nav-link w-100 border-0 bg-transparent text-start" style="color:rgba(255,255,255,.7);">
                <i class="bi bi-box-arrow-right"></i> Sair
              </button>
            </form>
          </li>
        </ul>
      </div>
    </div>
    {% endif %}

    <main class="container my-4">
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-toast alert-dismissible fade show d-flex align-items-center gap-2" role="alert">
              {% if message.tags == 'success' %}
                <i class="bi bi-check-circle-fill text-success"></i>
              {% elif message.tags == 'error' or message.tags == 'danger' %}
                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
              {% elif message.tags == 'warning' %}
                <i class="bi bi-exclamation-circle-fill text-warning"></i>
              {% else %}
                <i class="bi bi-info-circle-fill text-primary"></i>
              {% endif %}
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% block content %}{% endblock %}
    </main>

    <footer class="main-footer">
      <div class="container d-flex flex-wrap justify-content-between align-items-center">
        <span><i class="bi bi-building-gear"></i> Fiscalização de Obras &copy; {% now "Y" %}</span>
        {% if user.is_authenticated %}
        <span><i class="bi bi-person-circle"></i> {{ user.get_full_name|default:user.username }}</span>
        {% endif %}
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="" crossorigin="anonymous"></script>
    <script>
      // Highlight active nav link based on current path
      (function(){
        var path = window.location.pathname;
        document.querySelectorAll('.main-navbar .nav-link, .offcanvas-nav .nav-link').forEach(function(link){
          if(link.classList.contains('dropdown-toggle')) return;
          var href = link.getAttribute('href');
          if(href && href !== '/' && path.startsWith(href)){
            link.classList.add('active');
          }
        });
      })();
    </script>
    <script>
      // Theme toggle: persist user's choice in localStorage and apply class
      (function(){
        var storageKey = 'site-theme';
        var body = document.body;
        var btn = document.getElementById('themeToggle');
        var icon = document.getElementById('themeToggleIcon');
        var btnMobile = document.getElementById('themeToggleMobile');

        function applyTheme(theme){
          if(theme === 'dark'){
            body.classList.add('theme-dark');
            if(icon) icon.className = 'bi bi-sun-fill';
            if(btn) btn.title = 'Tema: Escuro (clicar para Alternar)';
            if(btnMobile) btnMobile.innerHTML = '<i class="bi bi-sun-fill"></i> Tema Claro';
          } else {
            body.classList.remove('theme-dark');
            // remove any variant classes
            body.classList.remove('variant-soft','variant-gray','variant-blue');
            if(icon) icon.className = 'bi bi-moon-fill';
            if(btn) btn.title = 'Tema: Claro (clicar para Alternar)';
            if(btnMobile) btnMobile.innerHTML = '<i class="bi bi-moon-fill"></i> Tema Escuro';
          }
        }

        function applyVariant(variant){
          // remove previous variant classes
          body.classList.remove('variant-soft','variant-gray','variant-blue');
          if(variant && variant !== 'default'){
            body.classList.add('variant-' + variant);
          }
        }

        function toggle(){
          var current = localStorage.getItem(storageKey) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
          var next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem(storageKey, next);
          applyTheme(next);
        }

        // initialize (server preference + variant override localStorage if available)
        var serverTheme = body.getAttribute('data-server-theme');
        var serverVariant = body.getAttribute('data-server-variant');
        var saved = localStorage.getItem(storageKey);
        var savedVariant = localStorage.getItem('site-variant');
        if(serverTheme){
          saved = serverTheme;
          localStorage.setItem(storageKey, serverTheme);
        }
        if(serverVariant){
          savedVariant = serverVariant;
          localStorage.setItem('site-variant', serverVariant);
        }
        if(!saved){
          saved = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        }
        applyTheme(saved);
        applyVariant(savedVariant || 'default');

        // populate popover UI
        var pop = document.getElementById('themePopover');
        var inputLight = document.getElementById('themeLight');
        var inputDark = document.getElementById('themeDark');
        var variantSelect = document.getElementById('themeVariantSelect');
        var applyBtn = document.getElementById('themeApplyBtn');
        if(inputLight) inputLight.checked = (saved === 'light');
        if(inputDark) inputDark.checked = (saved === 'dark');
        if(variantSelect && (savedVariant || serverVariant)) variantSelect.value = (savedVariant || serverVariant || 'default');

        // swatches click handlers
        document.querySelectorAll('.palette-swatch').forEach(function(btn){
          btn.addEventListener('click', function(){
            var v = btn.getAttribute('data-variant');
            if(variantSelect) variantSelect.value = v;
            // preview immediately
            applyTheme('dark');
            applyVariant(v);
            // mark visually (border)
            document.querySelectorAll('.palette-swatch').forEach(function(s){ s.style.outline = 'none'; });
            btn.style.outline = '2px solid rgba(255,255,255,.18)';
          });
        });

        function openPopover(){ pop.style.display = 'block'; }
        function closePopover(){ pop.style.display = 'none'; }

        btn.addEventListener('click', function(e){
          e.stopPropagation();
          if(pop.style.display === 'block') closePopover(); else openPopover();
        });
        document.addEventListener('click', function(){ closePopover(); });
        pop.addEventListener('click', function(e){ e.stopPropagation(); });

        // apply selection and persist both theme and variant
        applyBtn.addEventListener('click', function(){
          var chosenTheme = document.querySelector('input[name="site-theme"]:checked').value;
          var chosenVariant = variantSelect.value;
          localStorage.setItem(storageKey, chosenTheme);
          localStorage.setItem('site-variant', chosenVariant);
          applyTheme(chosenTheme);
          applyVariant(chosenVariant);
          closePopover();
          // send to server if logged in
          if(window.fetch && document.cookie.indexOf('sessionid') !== -1){
            fetch('{% url "funcionarios:set_theme" %}', {
              method: 'POST',
              headers: {
                'X-CSRFToken': (function(){ var m=document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)'); return m?m.pop():'' })(),
              },
              body: new URLSearchParams({theme: chosenTheme, variant: chosenVariant})
            }).catch(function(){/* ignore */});
          }
        });

        if(btnMobile) btnMobile.addEventListener('click', function(){
          // toggle between dark and light quickly on mobile
          var current = localStorage.getItem(storageKey) || 'light';
          var next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem(storageKey, next);
          applyTheme(next);
          // if switching to dark and no variant chosen, use savedVariant
          applyVariant(localStorage.getItem('site-variant') || 'default');
          if(window.fetch && document.cookie.indexOf('sessionid') !== -1){
            fetch('{% url "funcionarios:set_theme" %}', { method: 'POST', headers: {'X-CSRFToken': (function(){ var m=document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)'); return m?m.pop():'' })()}, body: new URLSearchParams({theme: next, variant: localStorage.getItem('site-variant') || 'default'}) }).catch(function(){});
          }
        });
      })();
    </script>
    {% block extra_js %}{% endblock %}
    <script>
    // Convert offcanvas dropdowns to collapses on mobile for better UX
    document.addEventListener('DOMContentLoaded', function(){
      if(window.innerWidth >= 992) return; // only for mobile
      var offcanvas = document.querySelector('.offcanvas-nav');
      if(!offcanvas) return;
      var collapseId = 0;
      offcanvas.querySelectorAll('.dropdown').forEach(function(dd){
        var toggle = dd.querySelector('[data-bs-toggle="dropdown"]');
        var menu = dd.querySelector('.dropdown-menu');
        if(!toggle || !menu) return;
        collapseId++;
        var id = 'offcanvasCollapse' + collapseId;
        menu.id = id;
        // change toggle from dropdown to collapse
        toggle.removeAttribute('data-bs-toggle');
        toggle.setAttribute('data-bs-toggle', 'collapse');
        toggle.setAttribute('data-bs-target', '#' + id);
        toggle.setAttribute('role', 'button');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-controls', id);
        // make menu collapsible
        menu.classList.remove('dropdown-menu');
        menu.classList.add('collapse');
        menu.style.padding = '.25rem 0';
      });
    });
    </script>
  </body>
</html>
