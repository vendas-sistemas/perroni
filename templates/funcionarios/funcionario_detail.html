{% extends 'base.html' %}
{% load obras_extras %}

{% block title %}{{ funcionario.nome_completo }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  .kpi-card { border: none; border-radius: .75rem; transition: transform .15s; }
  .kpi-card:hover { transform: translateY(-2px); }
  .kpi-value { font-size: 1.5rem; font-weight: 700; }
  .kpi-label { font-size: .82rem; color: #6c757d; }
  .preset-btn { font-size: .82rem; }
  .preset-btn.active { background-color: #0d6efd !important; color: #fff !important; }
  .section-header { font-size: 1rem; font-weight: 600; margin-bottom: .75rem; border-bottom: 2px solid #dee2e6; padding-bottom: .5rem; }
  .badge-pedreiro { background-color: #0d6efd; }
  .badge-servente { background-color: #6f42c1; }
  .table-compact th, .table-compact td { padding: .4rem .5rem; font-size: .9rem; }
  .obra-row:nth-child(odd) { background-color: #f8f9fa; }
  .avatar-lg { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 2rem; color: #fff; }
  .avatar-pedreiro { background-color: #0d6efd; }
  .avatar-servente { background-color: #6f42c1; }
  .quick-action { text-decoration: none; display: flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border-radius: .5rem; transition: background .15s; }
  .quick-action:hover { background-color: #e9ecef; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <!-- HEADER -->
  <div class="d-flex flex-wrap justify-content-between align-items-start mb-3 gap-2">
    <div class="d-flex align-items-center gap-3">
      {% if funcionario.foto %}
        <img src="{{ funcionario.foto.url }}" class="rounded-circle" width="80" height="80" alt="{{ funcionario.nome_completo }}" style="object-fit:cover;">
      {% else %}
        <div class="avatar-lg avatar-{{ funcionario.funcao }}">{{ funcionario.nome_completo|make_list|first }}</div>
      {% endif %}
      <div>
        <h1 class="h4 mb-0">{{ funcionario.nome_completo }}</h1>
        <div class="d-flex align-items-center gap-2 mt-1">
          <span class="badge {% if funcionario.funcao == 'pedreiro' %}badge-pedreiro{% else %}badge-servente{% endif %} px-2 py-1">
            {{ funcionario.get_funcao_display }}
          </span>
          <span class="text-muted">{{ funcionario.valor_diaria|brl }}/dia</span>
          <span class="badge {% if funcionario.ativo %}bg-success{% else %}bg-danger{% endif %}">
            {{ funcionario.ativo|yesno:'Ativo,Inativo' }}
          </span>
        </div>
        <small class="text-muted">CPF: {{ funcionario.cpf }} | Tel: {{ funcionario.telefone }}</small>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'funcionarios:apontamento_create' %}?funcionario={{ funcionario.pk }}" class="btn btn-success btn-sm">
        <i class="bi bi-plus-circle"></i> Registrar Dia
      </a>
      <a href="{% url 'funcionarios:funcionario_historico' funcionario.pk %}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-calendar3"></i> Calendário
      </a>
      <a href="{% url 'funcionarios:funcionario_update' funcionario.pk %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-pencil"></i> Editar
      </a>
    </div>
  </div>

  <!-- FILTRO DE PERÍODO -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body py-2 px-3">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="text-muted small me-1"><i class="bi bi-funnel"></i> Período:</span>
        <a href="?preset=semana" class="btn btn-sm preset-btn {% if preset == 'semana' %}active{% else %}btn-outline-secondary{% endif %}">Esta semana</a>
        <a href="?preset=quinzena" class="btn btn-sm preset-btn {% if preset == 'quinzena' %}active{% else %}btn-outline-secondary{% endif %}">Quinzena</a>
        <a href="?preset=30dias" class="btn btn-sm preset-btn {% if preset == '30dias' %}active{% else %}btn-outline-secondary{% endif %}">30 dias</a>
        <a href="?preset=mes" class="btn btn-sm preset-btn {% if preset == 'mes' %}active{% else %}btn-outline-secondary{% endif %}">Este mês</a>
        <a href="?preset=90dias" class="btn btn-sm preset-btn {% if preset == '90dias' %}active{% else %}btn-outline-secondary{% endif %}">90 dias</a>
        <span class="text-muted mx-1">|</span>
        <form method="get" class="d-flex align-items-center gap-1">
          <input type="date" name="data_inicio" value="{{ data_inicio|date:'Y-m-d' }}" class="form-control form-control-sm" style="width:140px;">
          <span class="text-muted">a</span>
          <input type="date" name="data_fim" value="{{ data_fim|date:'Y-m-d' }}" class="form-control form-control-sm" style="width:140px;">
          <button type="submit" class="btn btn-sm btn-primary">Filtrar</button>
        </form>
      </div>
      <small class="text-muted mt-1 d-block">
        Exibindo: {{ data_inicio|date:"d/m/Y" }} a {{ data_fim|date:"d/m/Y" }}
      </small>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="row g-2 mb-3">
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card kpi-card bg-primary bg-opacity-10">
        <div class="card-body text-center py-2">
          <div class="kpi-value text-primary">{{ total_dias }}</div>
          <div class="kpi-label">Dias Trabalhados</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card kpi-card bg-info bg-opacity-10">
        <div class="card-body text-center py-2">
          <div class="kpi-value text-info">{{ total_horas }}h</div>
          <div class="kpi-label">Horas Totais</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card kpi-card bg-success bg-opacity-10">
        <div class="card-body text-center py-2">
          <div class="kpi-value text-success">{{ total_valor|brl }}</div>
          <div class="kpi-label">Valor Total</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card kpi-card bg-secondary bg-opacity-10">
        <div class="card-body text-center py-2">
          <div class="kpi-value">{{ total_metragem }} m²</div>
          <div class="kpi-label">Metragem Total</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card kpi-card bg-warning bg-opacity-10">
        <div class="card-body text-center py-2">
          <div class="kpi-value text-warning">{{ taxa_ociosidade }}%</div>
          <div class="kpi-label">Ociosidade ({{ dias_ociosidade }}d)</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card kpi-card bg-danger bg-opacity-10">
        <div class="card-body text-center py-2">
          <div class="kpi-value text-danger">{{ taxa_retrabalho }}%</div>
          <div class="kpi-label">Retrabalho ({{ dias_retrabalho }}d)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- COLUNA ESQUERDA -->
    <div class="col-12 col-lg-8">

      {% if obras_periodo %}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="section-header"><i class="bi bi-building text-primary"></i> Obras no Período</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover table-compact mb-0">
              <thead class="table-light">
                <tr>
                  <th>Obra</th>
                  <th class="text-center">Dias</th>
                  <th class="text-center">Horas</th>
                  <th class="text-end">Valor</th>
                  <th class="text-center">m²</th>
                </tr>
              </thead>
              <tbody>
                {% for o in obras_periodo %}
                <tr class="obra-row">
                  <td>
                    <a href="{% url 'obras:obra_detail' o.obra__pk %}" class="text-decoration-none fw-semibold">
                      {{ o.obra__nome }}
                    </a>
                  </td>
                  <td class="text-center">{{ o.dias }}</td>
                  <td class="text-center">{{ o.horas }}h</td>
                  <td class="text-end fw-semibold">{{ o.valor|brl }}</td>
                  <td class="text-center">{{ o.metragem }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}

      {% if etapas_periodo %}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="section-header"><i class="bi bi-layers text-primary"></i> Etapas Trabalhadas</h6>
          <div class="d-flex flex-wrap gap-2">
            {% for ep in etapas_periodo %}
            <div class="border rounded p-2 text-center" style="min-width: 120px;">
              <div class="fw-bold small">{{ ep.etapa_nome }}</div>
              <div class="text-muted small">{{ ep.dias }} dia{{ ep.dias|pluralize:"s" }}</div>
              {% if ep.metragem %}<div class="small text-primary">{{ ep.metragem }} m²</div>{% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      {% if ultimos_apontamentos %}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="section-header"><i class="bi bi-clock-history text-primary"></i> Últimos Registros</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover table-compact mb-0">
              <thead class="table-light">
                <tr>
                  <th>Data</th>
                  <th>Obra</th>
                  <th>Etapa</th>
                  <th class="text-center">Horas</th>
                  <th class="text-end">Valor</th>
                  <th class="text-center">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for ap in ultimos_apontamentos %}
                <tr class="{% if ap.houve_retrabalho %}table-danger{% elif ap.houve_ociosidade %}table-warning{% endif %}">
                  <td>{{ ap.data|date:"d/m/Y" }}</td>
                  <td>{{ ap.obra.nome }}</td>
                  <td>{{ ap.etapa|default:"-" }}</td>
                  <td class="text-center">{{ ap.horas_trabalhadas }}h</td>
                  <td class="text-end">{{ ap.valor_diaria|brl }}</td>
                  <td class="text-center">
                    {% if ap.houve_retrabalho %}<span class="badge bg-danger" title="{{ ap.motivo_retrabalho }}">Retrabalho</span>
                    {% elif ap.houve_ociosidade %}<span class="badge bg-warning text-dark" title="{{ ap.observacao_ociosidade }}">Ocioso</span>
                    {% else %}<span class="badge bg-success">OK</span>{% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}

      {% if not obras_periodo and not ultimos_apontamentos %}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body text-center py-4 text-muted">
          <i class="bi bi-inbox" style="font-size: 2rem;"></i>
          <p class="mt-2 mb-0">Nenhum registro encontrado neste período.</p>
          <p class="small">Ajuste as datas ou registre um apontamento.</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- COLUNA DIREITA -->
    <div class="col-12 col-lg-4">

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="section-header"><i class="bi bi-person text-primary"></i> Dados Pessoais</h6>
          <p class="mb-1 small"><strong>RG:</strong> {{ funcionario.rg|default:"—" }}</p>
          <p class="mb-1 small"><strong>Nascimento:</strong> {{ funcionario.data_nascimento|date:"d/m/Y" }}</p>
          <p class="mb-1 small"><strong>Endereço:</strong> {{ funcionario.endereco }}, {{ funcionario.cidade }} - {{ funcionario.estado }}, {{ funcionario.cep }}</p>
          {% if funcionario.email %}<p class="mb-1 small"><strong>E-mail:</strong> {{ funcionario.email }}</p>{% endif %}
          <hr class="my-2">
          <p class="mb-1 small"><strong>Admissão:</strong> {{ funcionario.data_admissao|date:"d/m/Y" }}</p>
          {% if funcionario.data_demissao %}
            <p class="mb-1 small"><strong>Demissão:</strong> {{ funcionario.data_demissao|date:"d/m/Y" }}</p>
            <p class="mb-1 small"><strong>Motivo:</strong> {{ funcionario.motivo_inativacao }}</p>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="section-header"><i class="bi bi-cash-stack text-success"></i> Fechamentos / Pagamentos</h6>
          {% if fechamentos %}
          <div class="list-group list-group-flush">
            {% for f in fechamentos %}
            <a href="{% url 'funcionarios:fechamento_detail' f.pk %}" class="list-group-item list-group-item-action p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <small class="text-muted">{{ f.data_inicio|date:"d/m" }} a {{ f.data_fim|date:"d/m/Y" }}</small>
                  <div class="fw-bold">{{ f.total_valor|brl }}</div>
                </div>
                <div>
                  <span class="badge {% if f.status == 'pago' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                    {{ f.get_status_display }}
                  </span>
                  <div class="small text-muted">{{ f.total_dias }}d / {{ f.total_horas }}h</div>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted small text-center mb-0">Nenhum fechamento no período.</p>
          {% endif %}
          <div class="mt-2">
            <a href="{% url 'funcionarios:fechamento_create' %}?funcionario={{ funcionario.pk }}" class="btn btn-outline-success btn-sm w-100">
              <i class="bi bi-plus"></i> Novo Fechamento
            </a>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="section-header"><i class="bi bi-lightning text-warning"></i> Ações Rápidas</h6>
          <a href="{% url 'funcionarios:apontamento_create' %}?funcionario={{ funcionario.pk }}" class="quick-action text-success">
            <i class="bi bi-plus-circle fs-5"></i> Registrar apontamento
          </a>
          <a href="{% url 'funcionarios:funcionario_historico' funcionario.pk %}" class="quick-action text-primary">
            <i class="bi bi-calendar3 fs-5"></i> Ver calendário mensal
          </a>
          <a href="{% url 'funcionarios:apontamento_list' %}?funcionario={{ funcionario.pk }}" class="quick-action text-info">
            <i class="bi bi-journal-text fs-5"></i> Todos os apontamentos
          </a>
          <a href="{% url 'funcionarios:funcionario_list' %}" class="quick-action text-secondary">
            <i class="bi bi-arrow-left fs-5"></i> Voltar à lista
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
