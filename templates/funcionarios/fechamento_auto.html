{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title mb-3">⚡ Fechamento Semanal Automático</h4>
          <p class="text-muted">
            Gera fechamentos para todos os funcionários ativos que possuem apontamentos no período selecionado.
          </p>
          <div id="alerta-fechamento" class="alert alert-warning d-none" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Atenção!</strong> <span id="alerta-msg"></span>
          </div>
          <!-- Period presets -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Atalhos de Período</label>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary preset-btn" data-days="7">Semana</button>
              <button type="button" class="btn btn-sm btn-outline-primary preset-btn" data-days="15">Quinzena</button>
              <button type="button" class="btn btn-sm btn-outline-primary preset-btn" data-days="30">Mês</button>
            </div>
          </div>

          <form method="post" id="form-fechamento-auto">
            {% csrf_token %}
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Data de Início</label>
                <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ inicio_semana|date:'Y-m-d' }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Data de Fim</label>
                <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ fim_semana|date:'Y-m-d' }}" required>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="btn-gerar">Gerar Fechamentos</button>
              <a href="{% url 'funcionarios:fechamento_list' %}" class="btn btn-secondary">Voltar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const dataInicio = document.getElementById('data_inicio');
  const dataFim = document.getElementById('data_fim');
  const alerta = document.getElementById('alerta-fechamento');
  const alertaMsg = document.getElementById('alerta-msg');
  const btnGerar = document.getElementById('btn-gerar');
  const form = document.getElementById('form-fechamento-auto');
  const apiUrl = "{% url 'funcionarios:check_fechamento_api' %}";

  let semanaTemFechamento = false;

  // Preset buttons
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const days = parseInt(this.dataset.days);
      const hoje = new Date();
      // Find Monday of current week as base
      const dow = hoje.getDay();
      const monday = new Date(hoje);
      monday.setDate(hoje.getDate() - ((dow + 6) % 7));
      const end = new Date(monday);
      end.setDate(monday.getDate() + days - 1);
      dataInicio.value = monday.toISOString().slice(0, 10);
      dataFim.value = end.toISOString().slice(0, 10);
      verificarFechamento();
    });
  });

  async function verificarFechamento() {
    const di = dataInicio.value;
    const df = dataFim.value;
    if (!di || !df) {
      alerta.classList.add('d-none');
      semanaTemFechamento = false;
      btnGerar.disabled = false;
      return;
    }
    try {
      const resp = await fetch(apiUrl + '?data_inicio=' + di);
      if (!resp.ok) return;
      const data = await resp.json();
      if (data.exists) {
        semanaTemFechamento = true;
        let msg = `Já existe(m) ${data.count} fechamento(s) para este período.`;
        if (data.funcionarios && data.funcionarios.length > 0) {
          msg += ' Funcionários: ' + data.funcionarios.join(', ');
          if (data.count > data.funcionarios.length) {
            msg += ` e mais ${data.count - data.funcionarios.length}...`;
          }
        }
        alertaMsg.textContent = msg;
        alerta.classList.remove('d-none');
        btnGerar.disabled = true;
      } else {
        semanaTemFechamento = false;
        alerta.classList.add('d-none');
        btnGerar.disabled = false;
      }
    } catch(e) {
      console.error(e);
    }
  }

  dataInicio.addEventListener('change', verificarFechamento);
  dataFim.addEventListener('change', verificarFechamento);

  form.addEventListener('submit', function(e) {
    if (semanaTemFechamento) {
      e.preventDefault();
      alert('Não é possível gerar fechamentos: já existe fechamento para o período selecionado.');
    }
  });

  document.addEventListener('DOMContentLoaded', verificarFechamento);
})();
</script>
{% endblock %}
