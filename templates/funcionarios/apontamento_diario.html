{% extends 'base.html' %}
{% load obras_extras %}

{% block title %}Registro Diário{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  .step-indicator { display: flex; gap: .5rem; margin-bottom: 1rem; }
  .step-indicator .step { flex: 1; text-align: center; padding: .5rem; border-radius: .5rem; background: #f1f3f5; font-size: .9rem; }
  .step-indicator .step.active { background: #0d6efd; color: #fff; }
  .step-indicator .step.done { background: #198754; color: #fff; }

  .badge-clima-sol { background-color: #ffc107; color: #333; }
  .badge-clima-chuva { background-color: #6c757d; }
  .badge-clima-nublado { background-color: #adb5bd; color: #333; }

  .func-row { transition: background-color .15s; }
  .func-row:hover { background-color: #e9ecef; }
  .func-row.selected { background-color: #d1ecf1; }
  .func-row.ja-apontado { background-color: #d4edda; }
  .func-row.bloqueado { background-color: #f8d7da; opacity: .7; }

  .badge-pedreiro { background-color: #0d6efd; }
  .badge-servente { background-color: #6f42c1; }

  .batch-table th { font-size: .85rem; white-space: nowrap; }
  .batch-table td { vertical-align: middle; }
  .batch-table .form-control-sm, .batch-table .form-select-sm { font-size: .85rem; }

  .apontados-header { background: #1b2a4a; color: #fff; }
  .apontamentos-table thead { background: #1b2a4a; }
  .apontamentos-table thead th { color: #fff; font-weight: 600; padding: .5rem; border-color: #1b2a4a; }

  .select-all-container { cursor: pointer; }
  .form-check-input { width: 1.3rem; height: 1.3rem; }

  @media (max-width: 768px) {
    .table-responsive { font-size: .85rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <h4 class="mb-3"><i class="bi bi-clipboard-check text-primary"></i> Registro Diário de Mão de Obra</h4>

  <div class="step-indicator">
    <div class="step {% if obra %}done{% else %}active{% endif %}">1. Obra & Data</div>
    <div class="step {% if obra %}active{% endif %}">2. Marcar Funcionários</div>
  </div>

  <!-- STEP 1: Select Obra, Date, Clima -->
  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Selecione a Obra</h5>
      <form method="get" class="row g-2">
        <div class="col-12 col-md-4">
          <label class="form-label fw-semibold">Obra</label>
          {{ cab_form.obra }}
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label fw-semibold">Data</label>
          {{ cab_form.data }}
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label fw-semibold">Clima</label>
          {{ cab_form.clima }}
        </div>
        <div class="col-12 col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-arrow-right"></i> Carregar
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if obra and data %}
  <!-- Header info bar -->
  <div class="alert alert-info d-flex flex-wrap justify-content-between align-items-center py-2 mb-3">
    <div>
      <strong>{{ obra.nome }}</strong> &mdash; {{ data|date:"d/m/Y" }}
      <span class="badge badge-clima-{{ clima }}">{{ clima|upper }}</span>
    </div>
    <div>
      <span class="badge bg-primary">{{ obra.percentual_concluido }}% concluído</span>
      <strong>{{ apontamentos_existentes|length }}</strong> funcionário(s) já apontado(s)
    </div>
  </div>

  <!-- Existing appointments (if any) -->
  {% if apontamentos_existentes %}
  <div class="card mb-3 shadow-sm border-0">
    <div class="card-header d-flex justify-content-between apontados-header">
      <span><i class="bi bi-check2-all"></i> <strong>Já Apontados Hoje</strong></span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 apontamentos-table">
          <thead>
            <tr>
              <th>Funcionário</th>
              <th>Função</th>
              <th>Etapa</th>
              <th class="text-center">Horas</th>
              <th class="text-end">Valor</th>
              <th class="text-center">Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for ap in apontamentos_existentes %}
            <tr class="{% if ap.houve_retrabalho %}table-danger{% elif ap.houve_ociosidade %}table-warning{% endif %}">
              <td>
                <a href="{% url 'funcionarios:funcionario_detail' ap.funcionario.pk %}" class="text-decoration-none">
                  {{ ap.funcionario.nome_completo }}
                </a>
              </td>
              <td><span class="badge {% if ap.funcionario.funcao == 'pedreiro' %}badge-pedreiro{% else %}badge-servente{% endif %}">{{ ap.funcionario.get_funcao_display }}</span></td>
              <td>{{ ap.etapa|default:"-" }}</td>
              <td class="text-center">{{ ap.horas_trabalhadas }}h</td>
              <td class="text-end">{{ ap.valor_diaria|brl }}</td>
              <td class="text-center">
                {% if ap.houve_retrabalho %}<span class="badge bg-danger">Retrabalho</span>{% endif %}
                {% if ap.houve_ociosidade %}<span class="badge bg-warning text-dark">Ocioso</span>{% endif %}
                {% if not ap.houve_retrabalho and not ap.houve_ociosidade %}<span class="badge bg-success">OK</span>{% endif %}
              </td>
              <td>
                <form method="post" action="{% url 'funcionarios:apontamento_delete' ap.pk %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remover {{ ap.funcionario.nome_completo }}?')">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- STEP 2: Batch selection table -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <strong><i class="bi bi-people"></i> Marcar Funcionários que Trabalharam</strong>
      <small>Marque os funcionários, ajuste horas/etapa se necessário, e salve tudo de uma vez.</small>
    </div>
    <div class="card-body p-0">
      <form method="post" id="batch-form">
        {% csrf_token %}
        <input type="hidden" name="obra" value="{{ obra.pk }}">
        <input type="hidden" name="data_apontamento" value="{{ data|date:'Y-m-d' }}">
        <input type="hidden" name="clima_apontamento" value="{{ clima }}">

        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 batch-table">
            <thead class="table-light">
              <tr>
                <th style="width: 50px;" class="text-center">
                  <div class="form-check d-flex justify-content-center">
                    <input type="checkbox" class="form-check-input" id="select-all" title="Selecionar todos">
                  </div>
                </th>
                <th>Funcionário</th>
                <th class="text-center" style="width: 100px;">Função</th>
                <th style="width: 130px;">Etapa</th>
                <th class="text-center" style="width: 90px;">Horas</th>
                <th class="text-end" style="width: 110px;">Diária</th>
                <th class="text-center" style="width: 80px;">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for f in funcionarios_disponiveis %}
              <tr class="func-row {% if f.ja_apontado %}ja-apontado{% elif f.bloqueado %}bloqueado{% endif %}" data-func-id="{{ f.obj.pk }}">
                <td class="text-center">
                  {% if f.bloqueado %}
                    <span class="text-danger" title="Apontado em outra obra"><i class="bi bi-x-circle"></i></span>
                  {% else %}
                    <div class="form-check d-flex justify-content-center">
                      <input type="checkbox" class="form-check-input func-check" name="func_ids" value="{{ f.obj.pk }}"
                        {% if f.ja_apontado %}checked{% endif %}>
                    </div>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'funcionarios:funcionario_detail' f.obj.pk %}" class="text-decoration-none fw-semibold">
                    {{ f.obj.nome_completo }}
                  </a>
                </td>
                <td class="text-center">
                  <span class="badge {% if f.obj.funcao == 'pedreiro' %}badge-pedreiro{% else %}badge-servente{% endif %}">
                    {{ f.obj.get_funcao_display }}
                  </span>
                </td>
                <td>
                  {% if not f.bloqueado %}
                  <select name="etapa_{{ f.obj.pk }}" class="form-select form-select-sm">
                    <option value="">—</option>
                    {% for e in etapas %}
                    <option value="{{ e.pk }}">{{ e.get_numero_etapa_display }}</option>
                    {% endfor %}
                  </select>
                  {% else %}
                  <span class="text-muted small">—</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if not f.bloqueado %}
                  <input type="number" name="horas_{{ f.obj.pk }}" value="8.0" step="0.5" min="0.5" max="24" class="form-control form-control-sm text-center" style="width:80px; margin:auto;">
                  {% else %}
                  <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">{{ f.obj.valor_diaria|brl }}</td>
                <td class="text-center">
                  {% if f.ja_apontado %}
                    <span class="badge bg-success"><i class="bi bi-check"></i></span>
                  {% elif f.bloqueado %}
                    <span class="badge bg-danger" title="Em outra obra">Outra obra</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center py-3 text-muted">Nenhum funcionário ativo cadastrado.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card-footer bg-white d-flex justify-content-between align-items-center py-3">
          <div>
            <span class="text-muted" id="selected-count">0 selecionado(s)</span>
          </div>
          <button type="submit" name="salvar_lote" value="1" class="btn btn-success btn-lg" id="btn-salvar">
            <i class="bi bi-check2-all"></i> Salvar Apontamentos
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.func-check');
  const countSpan = document.getElementById('selected-count');
  const btnSalvar = document.getElementById('btn-salvar');

  function updateCount() {
    const checked = document.querySelectorAll('.func-check:checked').length;
    if (countSpan) countSpan.textContent = checked + ' selecionado(s)';
    if (btnSalvar) btnSalvar.disabled = checked === 0;
  }

  function updateRowHighlight(cb) {
    const row = cb.closest('tr');
    if (row) {
      if (cb.checked) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
    }
  }

  if (selectAll) {
    selectAll.addEventListener('change', function() {
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        updateRowHighlight(cb);
      });
      updateCount();
    });
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      updateRowHighlight(this);
      updateCount();
      // Update select-all state
      if (selectAll) {
        selectAll.checked = document.querySelectorAll('.func-check:checked').length === checkboxes.length;
      }
    });
    // Init highlight for pre-checked
    if (cb.checked) updateRowHighlight(cb);
  });

  updateCount();
});
</script>
{% endblock %}
