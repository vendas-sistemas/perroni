{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
  .cal-day { min-height: 80px; border: 1px solid #dee2e6; padding: .25rem; font-size: .8rem; }
  .cal-day.empty { background: #f8f9fa; }
  .cal-day .day-num { font-weight: bold; font-size: .9rem; }
  .cal-day .ap-info { background: #e7f5ff; border-radius: 4px; padding: 2px 4px; margin-top: 2px; }
  .cal-day .ap-info.ociosidade { background: #fff3cd; }
  .cal-day .ap-info.retrabalho { background: #f8d7da; }
  @media (max-width: 768px) {
    .cal-day { min-height: 60px; font-size: .7rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h3>üìÖ Hist√≥rico - {{ funcionario.nome_completo }}</h3>
    <span class="badge bg-secondary fs-6">{{ funcionario.get_funcao_display }} - R$ {{ funcionario.valor_diaria }}/dia</span>
  </div>

  <!-- Month navigation -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="?mes={{ prev_month }}" class="btn btn-outline-primary">&larr; Anterior</a>
    <h4 class="mb-0">{{ mes_nome }} {{ ano }}</h4>
    <a href="?mes={{ next_month }}" class="btn btn-outline-primary">Pr√≥ximo &rarr;</a>
  </div>

  <!-- Stats -->
  <div class="row g-2 mb-3">
    <div class="col-4 col-md-2">
      <div class="card text-center">
        <div class="card-body p-2">
          <div class="small text-muted">Dias</div>
          <div class="h5 mb-0">{{ stats.total_dias|default:"0" }}</div>
        </div>
      </div>
    </div>
    <div class="col-4 col-md-2">
      <div class="card text-center">
        <div class="card-body p-2">
          <div class="small text-muted">Horas</div>
          <div class="h5 mb-0">{{ stats.total_horas|default:"0" }}h</div>
        </div>
      </div>
    </div>
    <div class="col-4 col-md-2">
      <div class="card text-center bg-success text-white">
        <div class="card-body p-2">
          <div class="small">Valor</div>
          <div class="h5 mb-0">R$ {{ stats.total_valor|default:"0.00" }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center border-warning">
        <div class="card-body p-2">
          <div class="small text-muted">Ociosidade</div>
          <div class="h5 mb-0 text-warning">{{ stats.dias_ociosidade|default:"0" }} dias</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center border-danger">
        <div class="card-body p-2">
          <div class="small text-muted">Retrabalho</div>
          <div class="h5 mb-0 text-danger">{{ stats.dias_retrabalho|default:"0" }} dias</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Obras no m√™s -->
  {% if obras_mes %}
  <div class="card mb-3">
    <div class="card-header"><strong>Obras no M√™s</strong></div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0">
        <thead class="table-light">
          <tr><th>Obra</th><th>Dias</th><th>Horas</th></tr>
        </thead>
        <tbody>
          {% for o in obras_mes %}
          <tr>
            <td>{{ o.obra__nome }}</td>
            <td>{{ o.dias }}</td>
            <td>{{ o.horas }}h</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Calendar -->
  <div class="card">
    <div class="card-body p-2">
      <div class="row g-0">
        <div class="col text-center fw-bold py-1 border-bottom">Seg</div>
        <div class="col text-center fw-bold py-1 border-bottom">Ter</div>
        <div class="col text-center fw-bold py-1 border-bottom">Qua</div>
        <div class="col text-center fw-bold py-1 border-bottom">Qui</div>
        <div class="col text-center fw-bold py-1 border-bottom">Sex</div>
        <div class="col text-center fw-bold py-1 border-bottom">S√°b</div>
        <div class="col text-center fw-bold py-1 border-bottom">Dom</div>
      </div>
      {% for week in calendar_weeks %}
      <div class="row g-0">
        {% for day_data in week %}
        {% if day_data %}
        <div class="col cal-day">
          <div class="day-num">{{ day_data.day }}</div>
          {% if day_data.apontamento %}
            {% with ap=day_data.apontamento %}
            <div class="ap-info {% if ap.houve_retrabalho %}retrabalho{% elif ap.houve_ociosidade %}ociosidade{% endif %}">
              <div class="fw-bold text-truncate" title="{{ ap.obra.nome }}">{{ ap.obra.nome|truncatechars:12 }}</div>
              <div>{{ ap.horas_trabalhadas }}h</div>
              {% if ap.etapa %}<div class="text-muted">E{{ ap.etapa.numero_etapa }}</div>{% endif %}
              {% if ap.houve_retrabalho %}<span class="text-danger">‚ö†Ô∏èR</span>{% endif %}
              {% if ap.houve_ociosidade %}<span class="text-warning">‚ö†Ô∏èO</span>{% endif %}
            </div>
            {% endwith %}
          {% endif %}
        </div>
        {% else %}
        <div class="col cal-day empty"></div>
        {% endif %}
        {% endfor %}
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <a href="{% url 'funcionarios:funcionario_detail' funcionario.pk %}" class="btn btn-secondary">Voltar ao Perfil</a>
    <a href="{% url 'analytics:pedreiro_rendimento' funcionario.pk %}" class="btn btn-outline-primary">Ver An√°lise de Rendimento</a>
  </div>
</div>
{% endblock %}
