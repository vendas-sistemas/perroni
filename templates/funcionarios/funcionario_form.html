{% extends 'base.html' %}

{% block title %}{{ title|default:'Cadastrar Funcionário' }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  .section-icon {
    width: 38px;
    height: 38px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: .5rem;
    font-size: 1.1rem;
    flex-shrink: 0;
  }
  .form-group-row {
    padding: .85rem 0;
    border-bottom: 1px solid #eef0f3;
    margin-bottom: 0;
  }
  .form-group-row:last-child { border-bottom: none; }
  .form-group-row label { margin-bottom: .35rem; }
  .btn-bar {
    position: sticky;
    bottom: 0;
    z-index: 10;
    background: #fff;
    border-top: 1px solid #dee2e6;
    padding: .85rem 1.25rem;
    margin: 0 -12px;
    border-radius: 0 0 .375rem .375rem;
  }
  @media (max-width: 575.98px) {
    .btn-bar { padding: .75rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 880px;">

  {# ── Cabeçalho ── #}
  <div class="d-flex align-items-center gap-3 mb-4">
    <div class="section-icon bg-primary text-white" style="width:48px;height:48px;font-size:1.4rem;">
      <i class="bi bi-person-plus-fill"></i>
    </div>
    <div>
      <h3 class="mb-0">{{ title|default:'Cadastrar Funcionário' }}</h3>
      <small class="text-muted">Preencha os dados abaixo.</small>
    </div>
  </div>

  {% if form.errors %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Corrija os erros abaixo:</strong>
    <ul class="mb-0 mt-1">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {# ══════════ DADOS PESSOAIS ══════════ #}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex align-items-center gap-2 py-3">
        <span class="section-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-person-fill"></i></span>
        <h5 class="mb-0">Dados Pessoais</h5>
      </div>
      <div class="card-body px-4">
        <div class="form-group-row">
          <label class="form-label fw-semibold"><i class="bi bi-person me-1 text-muted"></i> Nome Completo</label>
            {{ form.nome_completo }}
          {% if form.nome_completo.errors %}<div class="text-danger small mt-1">{{ form.nome_completo.errors.0 }}</div>{% endif %}
        </div>

        <div class="form-group-row">
          <div class="row g-3">
            <div class="col-sm-6 col-md-5">
              <label class="form-label fw-semibold"><i class="bi bi-card-text me-1 text-muted"></i> CPF</label>
                {{ form.cpf }}
              {% if form.cpf.errors %}<div class="text-danger small mt-1">{{ form.cpf.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-sm-6 col-md-3">
              <label class="form-label fw-semibold"><i class="bi bi-card-heading me-1 text-muted"></i> RG</label>
                {{ form.rg }}
            </div>
            <div class="col-sm-12 col-md-4">
              <label class="form-label fw-semibold"><i class="bi bi-calendar-event me-1 text-muted"></i> Nascimento</label>
                {{ form.data_nascimento }}
            </div>
          </div>
        </div>

        <div class="form-group-row">
          <label class="form-label fw-semibold"><i class="bi bi-camera-fill me-1 text-muted"></i> Foto</label>
          {{ form.foto }}
        </div>
      </div>
    </div>

    {# ══════════ CONTATO ══════════ #}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex align-items-center gap-2 py-3">
        <span class="section-icon bg-info bg-opacity-10 text-info"><i class="bi bi-telephone-fill"></i></span>
        <h5 class="mb-0">Contato</h5>
      </div>
      <div class="card-body px-4">
        <div class="form-group-row">
          <div class="row g-3">
            <div class="col-sm-5">
              <label class="form-label fw-semibold"><i class="bi bi-telephone me-1 text-muted"></i> Telefone</label>
              {{ form.telefone }}
            </div>
            <div class="col-sm-7">
              <label class="form-label fw-semibold"><i class="bi bi-envelope me-1 text-muted"></i> E-mail</label>
              {{ form.email }}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ══════════ ENDEREÇO ══════════ #}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex align-items-center gap-2 py-3">
        <span class="section-icon bg-success bg-opacity-10 text-success"><i class="bi bi-geo-alt-fill"></i></span>
        <h5 class="mb-0">Endereço</h5>
      </div>
      <div class="card-body px-4">
        <div class="form-group-row">
          <label class="form-label fw-semibold"><i class="bi bi-house-door me-1 text-muted"></i> Endereço</label>
          {{ form.endereco }}
        </div>

        <div class="form-group-row">
          <div class="row g-3">
            <div class="col-sm-5">
              <label class="form-label fw-semibold"><i class="bi bi-building me-1 text-muted"></i> Cidade</label>
              {{ form.cidade }}
            </div>
            <div class="col-4 col-sm-3">
              <label class="form-label fw-semibold"><i class="bi bi-map me-1 text-muted"></i> Estado</label>
              {{ form.estado }}
            </div>
            <div class="col-8 col-sm-4">
              <label class="form-label fw-semibold"><i class="bi bi-mailbox me-1 text-muted"></i> CEP</label>
              {{ form.cep }}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ══════════ FUNÇÃO E REMUNERAÇÃO ══════════ #}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex align-items-center gap-2 py-3">
        <span class="section-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-briefcase-fill"></i></span>
        <h5 class="mb-0">Função e Remuneração</h5>
      </div>
      <div class="card-body px-4">
        <div class="form-group-row">
          <div class="row g-3">
            <div class="col-sm-6">
              <label class="form-label fw-semibold"><i class="bi bi-tools me-1 text-muted"></i> Função</label>
              {{ form.funcao }}
            </div>
            <div class="col-sm-6">
              <label class="form-label fw-semibold"><i class="bi bi-currency-dollar me-1 text-muted"></i> Valor da Diária (R$)</label>
              {{ form.valor_diaria }}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ══════════ SITUAÇÃO / VÍNCULO ══════════ #}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex align-items-center gap-2 py-3">
        <span class="section-icon bg-secondary bg-opacity-10 text-secondary"><i class="bi bi-clipboard-check-fill"></i></span>
        <h5 class="mb-0">Situação e Vínculo</h5>
      </div>
      <div class="card-body px-4">
        <div class="form-group-row">
          <div class="row g-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label fw-semibold"><i class="bi bi-calendar-plus me-1 text-muted"></i> Admissão</label>
              {{ form.data_admissao }}
            </div>
            <div class="col-sm-4">
              <label class="form-label fw-semibold"><i class="bi bi-calendar-x me-1 text-muted"></i> Demissão</label>
              {{ form.data_demissao }}
            </div>
            <div class="col-sm-4">
              <div class="form-check form-switch mb-2">
                {{ form.ativo }}
                <label class="form-check-label fw-semibold ms-2">
                  <i class="bi bi-toggle-on me-1 text-muted"></i> Ativo
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group-row">
          <label class="form-label fw-semibold"><i class="bi bi-chat-left-text me-1 text-muted"></i> Motivo da Inativação</label>
          {{ form.motivo_inativacao }}
        </div>
      </div>
    </div>

    {# ══════════ BOTÕES ══════════ #}
    <div class="card shadow-sm mb-4">
      <div class="card-body px-4 py-3">
        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'funcionarios:funcionario_list' %}" class="btn btn-outline-secondary px-4">
            <i class="bi bi-x-lg me-1"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-primary px-4">
            <i class="bi bi-check-lg me-1"></i> Salvar
          </button>
        </div>
      </div>
    </div>

  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple input masks: CPF, telefone, CEP
function setInputMask(selector, fn) {
  const el = document.querySelector(selector);
  if (!el) return;
  el.addEventListener('input', function(){
    const start = this.selectionStart;
    this.value = fn(this.value);
    try { this.selectionStart = this.selectionEnd = start; } catch(e){}
  });
}

function maskCPF(v){
  v = v.replace(/\D/g,'');
  v = v.replace(/(\d{3})(\d)/, '$1.$2');
  v = v.replace(/(\d{3})(\d)/, '$1.$2');
  v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  return v;
}

function maskPhone(v){
  v = v.replace(/\D/g,'');
  if (v.length > 10) {
    v = v.replace(/(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
  } else if (v.length > 5) {
    v = v.replace(/(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
  } else if (v.length > 2) {
    v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
  }
  return v;
}

function maskCEP(v){
  v = v.replace(/\D/g,'');
  v = v.replace(/(\d{5})(\d)/, '$1-$2');
  return v;
}

document.addEventListener('DOMContentLoaded', function(){
  setInputMask('input[name="cpf"]', maskCPF);
  setInputMask('input[name="telefone"]', maskPhone);
  setInputMask('input[name="cep"]', maskCEP);
});
</script>
{% endblock %}
