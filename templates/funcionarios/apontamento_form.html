{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title mb-3">{{ title }}</h4>
          <p class="text-muted">Para apontar múltiplos funcionários de uma vez, use o <a href="{% url 'funcionarios:apontamento_diario' %}">Registro Diário</a>.</p>
          <form method="post">
            {% csrf_token %}
            {% if form.non_field_errors %}
              <div class="mb-3">
                {% for err in form.non_field_errors %}
                  <div class="alert alert-danger">{{ err }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Funcionário *</label>
                {{ form.funcionario }}
                {% for error in form.funcionario.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Obra *</label>
                {{ form.obra }}
                {% for error in form.obra.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Etapa/Fase</label>
                {{ form.etapa }}
                <div class="form-text text-muted" id="etapa-hint">Selecione uma obra para carregar as etapas.</div>
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Data *</label>
                {{ form.data }}
                {% for error in form.data.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Horas Trabalhadas</label>
                {{ form.horas_trabalhadas }}
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Clima *</label>
                {{ form.clima }}
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Metragem Executada (m²)</label>
                {{ form.metragem_executada }}
                <div class="form-text">Área executada no dia.</div>
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Valor Diária</label>
                {{ form.valor_diaria }}
                <div class="form-text">Automático se vazio.</div>
              </div>
            </div>

            <!-- ═══ Campos da Etapa (carregados dinamicamente) ═══ -->
            <div id="etapa-items-section" class="mt-4" style="display:none;">
              <hr>
              <h5 class="mb-3"><i class="bi bi-list-check text-primary"></i> Itens da Etapa <span id="etapa-items-title" class="text-primary"></span></h5>
              <p class="text-muted small">Preencha o progresso realizado neste apontamento. Valores numéricos serão <strong>adicionados</strong> ao acumulado atual.</p>
              <input type="hidden" name="items_etapa_id" id="items_etapa_id" value="">
              <div id="etapa-items-container" class="row g-3">
                <!-- Items rendered by JS -->
              </div>
            </div>

            <hr>
            <h5>Ocorrências</h5>
            <div class="row g-3">
              <div class="col-6">
                <div class="form-check">
                  {{ form.houve_ociosidade }}
                  <label class="form-check-label" for="{{ form.houve_ociosidade.id_for_label }}">Houve Ociosidade?</label>
                </div>
              </div>
              <div class="col-12" id="ociosidade-wrap" style="display:none;">
                <label class="form-label">Justificativa *</label>
                {{ form.observacao_ociosidade }}
                {% for error in form.observacao_ociosidade.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-6">
                <div class="form-check">
                  {{ form.houve_retrabalho }}
                  <label class="form-check-label" for="{{ form.houve_retrabalho.id_for_label }}">Houve Retrabalho?</label>
                </div>
              </div>
              <div class="col-12" id="retrabalho-wrap" style="display:none;">
                <label class="form-label">Motivo *</label>
                {{ form.motivo_retrabalho }}
                {% for error in form.motivo_retrabalho.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">Observações</label>
              {{ form.observacoes }}
            </div>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-primary">Salvar</button>
              <a href="{% url 'funcionarios:apontamento_list' %}" class="btn btn-secondary">Voltar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ── Ociosidade / Retrabalho toggles ──
  const oc = document.getElementById('{{ form.houve_ociosidade.id_for_label }}');
  const ow = document.getElementById('ociosidade-wrap');
  const rc = document.getElementById('{{ form.houve_retrabalho.id_for_label }}');
  const rw = document.getElementById('retrabalho-wrap');
  function toggleO() { if(oc && ow) ow.style.display = oc.checked ? 'block' : 'none'; }
  function toggleR() { if(rc && rw) rw.style.display = rc.checked ? 'block' : 'none'; }
  if(oc) { oc.addEventListener('change', toggleO); toggleO(); }
  if(rc) { rc.addEventListener('change', toggleR); toggleR(); }

  // ── Dynamic Etapa loading when Obra changes ──
  const obraSelect = document.getElementById('id_obra');
  const etapaSelect = document.getElementById('id_etapa');
  const etapaHint = document.getElementById('etapa-hint');
  const etapaItemsSection = document.getElementById('etapa-items-section');
  const etapaItemsContainer = document.getElementById('etapa-items-container');
  const etapaItemsTitle = document.getElementById('etapa-items-title');
  const itemsEtapaIdInput = document.getElementById('items_etapa_id');

  if (obraSelect && etapaSelect) {
    obraSelect.addEventListener('change', function() {
      const obraId = this.value;
      // Reset etapa
      etapaSelect.innerHTML = '<option value="">---------</option>';
      hideEtapaItems();

      if (!obraId) {
        if(etapaHint) etapaHint.textContent = 'Selecione uma obra para carregar as etapas.';
        return;
      }

      if(etapaHint) etapaHint.textContent = 'Carregando etapas...';

      fetch(`{% url 'funcionarios:etapas_por_obra_api' %}?obra_id=${obraId}`)
        .then(r => r.json())
        .then(data => {
          if (data.etapas && data.etapas.length > 0) {
            data.etapas.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e.id;
              opt.textContent = e.label;
              etapaSelect.appendChild(opt);
            });
            if(etapaHint) etapaHint.textContent = `${data.etapas.length} etapa(s) disponível(is).`;
          } else {
            if(etapaHint) etapaHint.textContent = 'Nenhuma etapa cadastrada para esta obra.';
          }
        })
        .catch(() => {
          if(etapaHint) etapaHint.textContent = 'Erro ao carregar etapas.';
        });
    });

    // ── Dynamic Etapa Items loading when Etapa changes ──
    etapaSelect.addEventListener('change', function() {
      const etapaId = this.value;
      if (!etapaId) {
        hideEtapaItems();
        return;
      }
      loadEtapaItems(etapaId);
    });

    // If obra is already selected (e.g. after validation error), trigger load
    if (obraSelect.value) {
      const currentEtapaVal = etapaSelect.value;
      obraSelect.dispatchEvent(new Event('change'));
      // Re-select the etapa after options are loaded
      if (currentEtapaVal) {
        setTimeout(() => {
          etapaSelect.value = currentEtapaVal;
          if (etapaSelect.value === currentEtapaVal) {
            loadEtapaItems(currentEtapaVal);
          }
        }, 500);
      }
    }
  }

  function hideEtapaItems() {
    if(etapaItemsSection) etapaItemsSection.style.display = 'none';
    if(etapaItemsContainer) etapaItemsContainer.innerHTML = '';
    if(itemsEtapaIdInput) itemsEtapaIdInput.value = '';
  }

  function loadEtapaItems(etapaId) {
    fetch(`{% url 'funcionarios:itens_etapa_api' %}?etapa_id=${etapaId}`)
      .then(r => r.json())
      .then(data => {
        if (!data.items || data.items.length === 0) {
          hideEtapaItems();
          return;
        }
        if(etapaItemsTitle) etapaItemsTitle.textContent = '— ' + data.etapa_label;
        if(itemsEtapaIdInput) itemsEtapaIdInput.value = data.etapa_id;
        renderEtapaItems(data.items);
        if(etapaItemsSection) etapaItemsSection.style.display = 'block';
      })
      .catch(() => hideEtapaItems());
  }

  function renderEtapaItems(items) {
    if(!etapaItemsContainer) return;
    etapaItemsContainer.innerHTML = '';
    items.forEach(item => {
      const col = document.createElement('div');
      col.className = 'col-md-6';

      if (item.type === 'boolean') {
        const currentLabel = item.value ? '<span class="badge bg-success">Concluído</span>' : '<span class="badge bg-secondary">Pendente</span>';
        col.innerHTML = `
          <div class="form-check border rounded p-3 h-100">
            <input type="hidden" name="item_${item.name}" value="0">
            <input class="form-check-input" type="checkbox" name="item_${item.name}" 
                   value="1" id="item_${item.name}" ${item.value ? 'checked disabled' : ''}>
            <label class="form-check-label" for="item_${item.name}">
              ${item.label} ${currentLabel}
            </label>
          </div>`;
      } else {
        const unit = item.type === 'decimal' ? 'step="0.01"' : 'step="1"';
        const currentStr = item.value != 0 && item.value != '0' && item.value != '0.00'
          ? `<span class="text-muted small">(Atual: <strong>${item.value}</strong>)</span>` 
          : '';
        col.innerHTML = `
          <div class="border rounded p-3 h-100">
            <label class="form-label mb-1" for="item_${item.name}">
              ${item.label} ${currentStr}
            </label>
            <input type="number" class="form-control form-control-sm" 
                   name="item_${item.name}" id="item_${item.name}" 
                   ${unit} min="0" placeholder="Incremento hoje" value="">
          </div>`;
      }
      etapaItemsContainer.appendChild(col);
    });
  }
});
</script>
{% endblock %}
