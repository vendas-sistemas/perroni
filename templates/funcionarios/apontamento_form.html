{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title mb-3">{{ title }}</h4>
          <p class="text-muted">Para apontar m√∫ltiplos funcion√°rios de uma vez, use o <a href="{% url 'funcionarios:apontamento_lote_create' %}">Apontamento em Lote</a>.</p>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% if form.non_field_errors %}
              <div class="mb-3">
                {% for err in form.non_field_errors %}
                  <div class="alert alert-danger">{{ err }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Funcion√°rio *</label>
                {{ form.funcionario }}
                {% for error in form.funcionario.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Obra *</label>
                <!-- text input for autocomplete; actual obra id stored in hidden field id_obra -->
                {{ form.obra_nome }}
                {{ form.obra }}
                <div id="obra-suggestions" class="list-group position-relative" style="z-index:1050;"></div>
                {% for error in form.obra.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Etapa/Fase</label>
                {{ form.etapa }}
                <div class="form-text text-muted" id="etapa-hint">Selecione uma obra para carregar as etapas.</div>
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Data *</label>
                {{ form.data }}
                {% for error in form.data.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Horas Trabalhadas</label>
                {{ form.horas_trabalhadas }}
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Clima *</label>
                {{ form.clima }}
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Metragem Executada (m¬≤)</label>
                {{ form.metragem_executada }}
                <div class="form-text">√Årea executada no dia.</div>
              </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê Campos da Etapa (carregados dinamicamente) ‚ïê‚ïê‚ïê -->
            <div id="etapa-items-section" class="mt-4" style="display:none;">
              <hr>
              <h5 class="mb-3"><i class="bi bi-list-check text-primary"></i> Itens da Etapa <span id="etapa-items-title" class="text-primary"></span></h5>
              <p class="text-muted small">Preencha o progresso realizado neste apontamento. Valores num√©ricos ser√£o <strong>adicionados</strong> ao acumulado atual.</p>
              <input type="hidden" name="items_etapa_id" id="items_etapa_id" value="">
              <div id="etapa-items-container" class="row g-3">
                <!-- Items rendered by JS -->
              </div>
            </div>

            <hr>
            <h5>Ocorr√™ncias</h5>
            <div class="row g-3">
              <div class="col-6">
                <div class="form-check">
                  {{ form.houve_ociosidade }}
                  <label class="form-check-label" for="{{ form.houve_ociosidade.id_for_label }}">Houve Ociosidade?</label>
                </div>
              </div>
              <div class="col-12" id="ociosidade-wrap" style="display:none;">
                <label class="form-label">Justificativa *</label>
                {{ form.observacao_ociosidade }}
                {% for error in form.observacao_ociosidade.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-6">
                <div class="form-check">
                  {{ form.houve_retrabalho }}
                  <label class="form-check-label" for="{{ form.houve_retrabalho.id_for_label }}">Houve Retrabalho?</label>
                </div>
              </div>
              <div class="col-12" id="retrabalho-wrap" style="display:none;">
                <label class="form-label">Motivo *</label>
                {{ form.motivo_retrabalho }}
                {% for error in form.motivo_retrabalho.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-6">
                <div class="form-check">
                  {{ form.possui_placa }}
                  <label class="form-check-label" for="{{ form.possui_placa.id_for_label }}">
                    Possui Placa
                  </label>
                </div>
              </div>
            </div>

            <hr>
            <h5>üì∑ Fotos</h5>
            <div class="mb-3">
              <label class="form-label">Adicionar Fotos</label>
              <input type="file" 
                     name="fotos" 
                     class="form-control" 
                     multiple
                     accept="image/*"
                     id="input-fotos">
              <small class="text-muted">
                Voc√™ pode selecionar m√∫ltiplas fotos
              </small>
              
              <!-- Preview das fotos -->
              <div id="preview-fotos" class="row mt-2"></div>
            </div>

            <div class="mt-3">
              <label class="form-label">Observa√ß√µes</label>
              {{ form.observacoes }}
            </div>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-primary">Salvar</button>
              <a href="{% url 'funcionarios:apontamento_list' %}" class="btn btn-secondary">Voltar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ‚îÄ‚îÄ Ociosidade / Retrabalho toggles ‚îÄ‚îÄ
  const oc = document.getElementById('{{ form.houve_ociosidade.id_for_label }}');
  const ow = document.getElementById('ociosidade-wrap');
  const rc = document.getElementById('{{ form.houve_retrabalho.id_for_label }}');
  const rw = document.getElementById('retrabalho-wrap');
  function toggleO() { if(oc && ow) ow.style.display = oc.checked ? 'block' : 'none'; }
  function toggleR() { if(rc && rw) rw.style.display = rc.checked ? 'block' : 'none'; }
  if(oc) { oc.addEventListener('change', toggleO); toggleO(); }
  if(rc) { rc.addEventListener('change', toggleR); toggleR(); }

  // ‚îÄ‚îÄ Dynamic Etapa loading when Obra changes ‚îÄ‚îÄ
  const obraSelect = document.getElementById('id_obra');
  const etapaSelect = document.getElementById('id_etapa');
  const etapaHint = document.getElementById('etapa-hint');
  const etapaItemsSection = document.getElementById('etapa-items-section');
  const etapaItemsContainer = document.getElementById('etapa-items-container');
  const etapaItemsTitle = document.getElementById('etapa-items-title');
  const itemsEtapaIdInput = document.getElementById('items_etapa_id');

  // Autocomplete textbox and suggestion handling
  const obraText = document.getElementById('id_obra_nome');
  const suggestionsBox = document.getElementById('obra-suggestions');

  function debounce(fn, wait){
    let t;
    return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
  }

  function clearSuggestions(){ suggestionsBox.innerHTML = ''; suggestionsBox.style.display = 'none'; }

  function selectObra(id, text){
    if(obraSelect) obraSelect.value = id; // hidden select contains id
    if(obraText) obraText.value = text;
    clearSuggestions();
    // explicitly load etapas for this obra id (don't rely only on change event)
    loadEtapasForObra(id);
  }

  if (obraText) {
    obraText.addEventListener('input', debounce(function(e){
      const q = this.value.trim();
      if(q.length < 1){ clearSuggestions(); return; }
      fetch(`{% url 'funcionarios:obras_autocomplete_api' %}?q=` + encodeURIComponent(q) + '&limit=10')
        .then(r => r.json())
        .then(data => {
          suggestionsBox.innerHTML = '';
          if(!data.results || data.results.length === 0){ clearSuggestions(); return; }
          data.results.forEach(r => {
            const a = document.createElement('button');
            a.type = 'button';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = r.text;
            a.addEventListener('click', ()=> selectObra(r.id, r.text));
            suggestionsBox.appendChild(a);
          });
          suggestionsBox.style.display = 'block';
        }).catch(()=> clearSuggestions());
    }, 250));

    // If user blurs, hide suggestions shortly after (allow click)
    obraText.addEventListener('blur', function(){ setTimeout(clearSuggestions, 150); });
  }

  if (obraSelect && etapaSelect) {
    function loadEtapasForObra(obraId){
      // Reset etapa
      etapaSelect.innerHTML = '<option value="">---------</option>';
      hideEtapaItems();

      if (!obraId) {
        if(etapaHint) etapaHint.textContent = 'Selecione uma obra para carregar as etapas.';
        return;
      }

      if(etapaHint) etapaHint.textContent = 'Carregando etapas...';

      fetch(`{% url 'funcionarios:etapas_por_obra_api' %}?obra_id=${obraId}`)
        .then(r => r.json())
        .then(data => {
          if (data.etapas && data.etapas.length > 0) {
            data.etapas.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e.id;
              opt.textContent = e.label;
              etapaSelect.appendChild(opt);
            });
            if(etapaHint) etapaHint.textContent = `${data.etapas.length} etapa(s) dispon√≠vel(is).`;
          } else {
            if(etapaHint) etapaHint.textContent = 'Nenhuma etapa cadastrada para esta obra.';
          }
        })
        .catch(() => {
          if(etapaHint) etapaHint.textContent = 'Erro ao carregar etapas.';
        });
    }
    obraSelect.addEventListener('change', function(){ loadEtapasForObra(this.value); });

    // ‚îÄ‚îÄ Dynamic Etapa Items loading when Etapa changes ‚îÄ‚îÄ
    etapaSelect.addEventListener('change', function() {
      const etapaId = this.value;
      if (!etapaId) {
        hideEtapaItems();
        return;
      }
      loadEtapaItems(etapaId);
    });

    // If obra is already selected (e.g. after validation error), trigger load
    // If a hidden obra id is present (e.g. form re-render after error), set text
    if (obraSelect.value) {
      // Try to set obra text from the server-rendered helper field value
      const currentText = document.getElementById('id_obra_nome') ? document.getElementById('id_obra_nome').value : '';
      if(currentText && document.getElementById('id_obra_nome').value === currentText){
        // nothing
      }
      const currentEtapaVal = etapaSelect.value;
      obraSelect.dispatchEvent(new Event('change'));
      if (currentEtapaVal) {
        setTimeout(() => {
          etapaSelect.value = currentEtapaVal;
          if (etapaSelect.value === currentEtapaVal) {
            loadEtapaItems(currentEtapaVal);
          }
        }, 500);
      }
    }
  }

  function hideEtapaItems() {
    if(etapaItemsSection) etapaItemsSection.style.display = 'none';
    if(etapaItemsContainer) etapaItemsContainer.innerHTML = '';
    if(itemsEtapaIdInput) itemsEtapaIdInput.value = '';
  }

  function loadEtapaItems(etapaId) {
    fetch(`{% url 'funcionarios:itens_etapa_api' %}?etapa_id=${etapaId}`)
      .then(r => r.json())
      .then(data => {
        if (!data.items || data.items.length === 0) {
          hideEtapaItems();
          return;
        }
        if(etapaItemsTitle) etapaItemsTitle.textContent = '‚Äî ' + data.etapa_label;
        if(itemsEtapaIdInput) itemsEtapaIdInput.value = data.etapa_id;
        renderEtapaItems(data.items);
        if(etapaItemsSection) etapaItemsSection.style.display = 'block';
      })
      .catch(() => hideEtapaItems());
  }

  function renderEtapaItems(items) {
    if(!etapaItemsContainer) return;
    etapaItemsContainer.innerHTML = '';
    items.forEach(item => {
      const col = document.createElement('div');
      col.className = 'col-md-6';

      if (item.type === 'boolean') {
        const currentLabel = item.value ? '<span class="badge bg-success">Conclu√≠do</span>' : '<span class="badge bg-secondary">Pendente</span>';
        col.innerHTML = `
          <div class="form-check border rounded p-3 h-100">
            <input type="hidden" name="item_${item.name}" value="0">
            <input class="form-check-input" type="checkbox" name="item_${item.name}" 
                   value="1" id="item_${item.name}" ${item.value ? 'checked disabled' : ''}>
            <label class="form-check-label" for="item_${item.name}">
              ${item.label} ${currentLabel}
            </label>
          </div>`;
      } else {
        if (item.type === 'date') {
          const currentStr = item.value
            ? `<span class="text-muted small">(Atual: <strong>${item.value}</strong>)</span>`
            : '';
          col.innerHTML = `
            <div class="border rounded p-3 h-100">
              <label class="form-label mb-1" for="item_${item.name}">
                ${item.label} ${currentStr}
              </label>
              <input type="date" class="form-control form-control-sm"
                     name="item_${item.name}" id="item_${item.name}"
                     value="${item.value || ''}">
            </div>`;
        } else {
          const unit = item.type === 'decimal' ? 'step="0.01"' : 'step="1"';
          const currentStr = item.value != 0 && item.value != '0' && item.value != '0.00'
            ? `<span class="text-muted small">(Atual: <strong>${item.value}</strong>)</span>` 
            : '';
          col.innerHTML = `
            <div class="border rounded p-3 h-100">
              <label class="form-label mb-1" for="item_${item.name}">
                ${item.label} ${currentStr}
              </label>
              <input type="number" class="form-control form-control-sm" 
                     name="item_${item.name}" id="item_${item.name}" 
                     ${unit} min="0" placeholder="Incremento hoje" value="">
            </div>`;
        }
      }
      etapaItemsContainer.appendChild(col);
    });
  }

  // Preview de fotos
  document.getElementById('input-fotos').addEventListener('change', function(e) {
    const preview = document.getElementById('preview-fotos');
    preview.innerHTML = '';
    
    if (e.target.files.length > 0) {
      for (let file of e.target.files) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const col = document.createElement('div');
          col.className = 'col-md-2 mb-2';
          col.innerHTML = `
            <img src="${e.target.result}" 
                 class="img-thumbnail" 
                 style="max-height: 100px; width: 100%; object-fit: cover;">
          `;
          preview.appendChild(col);
        };
        reader.readAsDataURL(file);
      }
    }
  });
});
</script>
{% endblock %}
