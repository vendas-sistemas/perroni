{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
  .filter-card { border: none; border-radius: .75rem; }
  .section-card { border: none; border-radius: .75rem; }
  .ranking-badge-best { background-color: #2e7d32; color: #fff; }
  .ranking-badge-worst { background-color: #c62828; color: #fff; }
  .metric-highlight {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1.2;
  }
  .metric-label-sm {
    font-size: .72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: #9e9e9e;
  }
  .table-ranking th {
    font-size: .78rem;
    text-transform: uppercase;
    letter-spacing: .03em;
  }
  .export-btn { min-width: 140px; }
  .empty-state {
    padding: 3rem;
    text-align: center;
    color: #9e9e9e;
  }
  .empty-state i { font-size: 3rem; margin-bottom: .75rem; display: block; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-bar-chart-line text-primary"></i> {{ title }}</h1>
      <small class="text-muted">An√°lise de produ√ß√£o di√°ria por pedreiro e etapa</small>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'funcionarios:apontamento_list' %}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-list-ul"></i> Apontamentos
      </a>
      <a href="{% url 'funcionarios:apontamento_create' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg"></i> Novo Apontamento
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card filter-card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" id="filtro-form">
        <div class="row g-3 align-items-end">
          <div class="col-md-2">
            <label class="form-label small fw-semibold">Obra</label>
            {{ form.obra }}
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-semibold">Etapa</label>
            {{ form.etapa }}
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-semibold">Funcion√°rio</label>
            {{ form.funcionario }}
          </div>
          <div class="col-md-1">
            <label class="form-label small fw-semibold">Clima</label>
            {{ form.clima }}
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-semibold">Data In√≠cio</label>
            {{ form.data_inicio }}
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-semibold">Data Fim</label>
            {{ form.data_fim }}
          </div>
          <div class="col-md-1 d-flex gap-1">
            <button type="submit" class="btn btn-primary btn-sm w-100">
              <i class="bi bi-funnel"></i> Filtrar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if filtros_informados %}
  <!-- Exporta√ß√µes -->
  <div class="d-flex gap-2 mb-4 flex-wrap">
    <a href="{% url 'relatorios:exportar_pdf' %}?{{ request.GET.urlencode }}"
       class="btn btn-danger btn-sm export-btn">
      <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
    </a>
    <a href="{% url 'relatorios:exportar_excel' %}?{{ request.GET.urlencode }}"
       class="btn btn-success btn-sm export-btn">
      <i class="bi bi-file-earmark-excel"></i> Exportar Excel
    </a>
  </div>
  {% endif %}

  {% if not ranking_por_etapas and not media_dias_etapa and not media_individual and not apontamentos_periodo %}
    <div class="card section-card shadow-sm">
      <div class="card-body empty-state">
        <i class="bi bi-clipboard-data"></i>
        <h5>Nenhum dado encontrado</h5>
        <p>Cadastre apontamentos di√°rios com metragem executada para visualizar os relat√≥rios.</p>
        <a href="{% url 'funcionarios:apontamento_create' %}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-lg"></i> Novo Apontamento
        </a>
      </div>
    </div>
  {% else %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SE√á√ÉO 1: Ranking por Etapa e Indicador      -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card section-card shadow-sm mb-4">
    <div class="card-header bg-white border-0 pt-3">
      <h5 class="mb-0"><i class="bi bi-trophy text-warning"></i> 1. Ranking por Etapa (Melhores e Piores)</h5>
      <small class="text-muted">Crit√©rio: m√©dia de quantidade produzida por dia em cada indicador</small>
    </div>
    <div class="card-body">
      {% for etapa in ranking_por_etapas %}
      <div class="mb-5">
        <h5 class="fw-bold text-primary mb-4" style="border-bottom: 2px solid #0d6efd; padding-bottom: 10px;">
          {{ etapa.nome }}
        </h5>
        
        {% for indicador in etapa.indicadores %}
        <div class="mb-4 p-3" style="background-color: #f8f9fa; border-left: 4px solid #0d6efd;">
          <h6 class="fw-bold text-secondary mb-3">
            üìä {{ indicador.nome }} ({{ indicador.unidade }})
          </h6>
          <div class="row g-3">
            <!-- Melhores -->
            <div class="col-md-6">
              <div class="border rounded p-3 h-100 bg-white">
                <span class="badge ranking-badge-best mb-2"><i class="bi bi-arrow-up-circle"></i> Top 3 Melhores</span>
                <table class="table table-sm table-ranking mb-0">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Pedreiro</th>
                      <th class="text-end">M√©dia {{ indicador.unidade }}/dia</th>
                      <th class="text-end">Dias</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for m in indicador.melhores %}
                    <tr>
                      <td>
                        {% if forloop.counter == 1 %}ü•á
                        {% elif forloop.counter == 2 %}ü•à
                        {% elif forloop.counter == 3 %}ü•â
                        {% else %}{{ forloop.counter }}{% endif %}
                      </td>
                      <td>{{ m.nome }}</td>
                      <td class="text-end fw-bold text-success">{{ m.media_producao }}</td>
                      <td class="text-end">{{ m.total_dias }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-muted text-center">Sem dados</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Piores -->
            <div class="col-md-6">
              <div class="border rounded p-3 h-100 bg-white">
                <span class="badge ranking-badge-worst mb-2"><i class="bi bi-arrow-down-circle"></i> Top 3 Piores</span>
                <table class="table table-sm table-ranking mb-0">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Pedreiro</th>
                      <th class="text-end">M√©dia {{ indicador.unidade }}/dia</th>
                      <th class="text-end">Dias</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in indicador.piores %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{ p.nome }}</td>
                      <td class="text-end fw-bold text-danger">{{ p.media_producao }}</td>
                      <td class="text-end">{{ p.total_dias }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-muted text-center">Sem dados</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">Nenhum indicador com dados para esta etapa.</p>
        {% endfor %}
      </div>
      {% empty %}
      <p class="text-muted">Nenhum dado de ranking dispon√≠vel.</p>
      {% endfor %}
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SE√á√ÉO 2: M√©dia de Dias por Etapa            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card section-card shadow-sm mb-4">
    <div class="card-header bg-white border-0 pt-3">
      <h5 class="mb-0"><i class="bi bi-calendar-week text-info"></i> 2. M√©dia de Dias para Execu√ß√£o de Cada Etapa</h5>
      <small class="text-muted">
        <i class="bi bi-info-circle"></i> Considerando apenas etapas em andamento de obras n√£o conclu√≠das
      </small>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Etapa</th>
              <th class="text-center">M√©dia de Dias</th>
              <th class="text-center">Obras Analisadas</th>
            </tr>
          </thead>
          <tbody>
            {% for e in media_dias_etapa %}
            <tr>
              <td class="fw-semibold">{{ e.etapa_nome }}</td>
              <td class="text-center">
                <span class="badge bg-info text-dark fs-6">{{ e.media_dias }} dias</span>
              </td>
              <td class="text-center">{{ e.total_obras }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-muted text-center">Sem dados</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SE√á√ÉO 3: M√©dia Individual                   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card section-card shadow-sm mb-4">
    <div class="card-header bg-white border-0 pt-3">
      <h5 class="mb-0"><i class="bi bi-person-lines-fill text-primary"></i> 3. Rendimento Individual por Pedreiro</h5>
      <small class="text-muted">Resumo do desempenho de cada pedreiro no per√≠odo selecionado: produ√ß√£o m√©dia di√°ria (blocos, m¬≤ etc.), dias trabalhados, horas, valor recebido e metragem executada.</small>
    </div>
    <div class="card-body">
      <!-- Legenda dos indicadores -->
      <div class="alert alert-secondary py-2 mb-3">
        <small>
          <strong>Produ√ß√£o m√©dia di√°ria por indicador:</strong>
          <span class="badge bg-primary ms-2">7F</span> Parede 7 Fiadas (blocos/dia) &nbsp;
          <span class="badge bg-secondary">Ali</span> Alicerce (%/dia) &nbsp;
          <span class="badge bg-info text-dark">Plat</span> Platibanda (blocos/dia) &nbsp;
          <span class="badge bg-warning text-dark">R.Ext</span> Reboco Externo (m¬≤/dia) &nbsp;
          <span class="badge bg-success">R.Int</span> Reboco Interno (m¬≤/dia) &nbsp;
          <span class="text-muted">‚Äî = sem registros no per√≠odo</span>
        </small>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle table-sm">
          <thead class="table-light">
            <tr>
              <th rowspan="2" class="align-middle">#</th>
              <th rowspan="2" class="align-middle">Pedreiro</th>
              <th colspan="5" class="text-center border-start border-end bg-light-blue">Produ√ß√£o M√©dia Di√°ria (por indicador)</th>
              <th rowspan="2" class="text-center align-middle">Dias<br>Trab.</th>
              <th rowspan="2" class="text-center align-middle">Ocio<br>sidade</th>
              <th rowspan="2" class="text-center align-middle">Retra<br>balho</th>
              <th rowspan="2" class="text-center align-middle">Horas</th>
              <th rowspan="2" class="text-center align-middle">Total<br>Recebido</th>
              <th rowspan="2" class="text-center align-middle">Metrag.<br>(m¬≤)</th>
            </tr>
            <tr>
              <th class="text-center border-start"><span class="badge bg-primary">7F</span><br><small class="text-muted fw-normal">blocos</small></th>
              <th class="text-center"><span class="badge bg-secondary">Ali</span><br><small class="text-muted fw-normal">%</small></th>
              <th class="text-center"><span class="badge bg-info text-dark">Plat</span><br><small class="text-muted fw-normal">blocos</small></th>
              <th class="text-center"><span class="badge bg-warning text-dark">R.Ext</span><br><small class="text-muted fw-normal">m¬≤</small></th>
              <th class="text-center border-end"><span class="badge bg-success">R.Int</span><br><small class="text-muted fw-normal">m¬≤</small></th>
            </tr>
          </thead>
          <tbody>
            {% for r in media_individual %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="fw-semibold">{{ r.nome }}</td>
              <td class="text-center border-start">
                {% if r.media_7fiadas != '-' %}<span class="badge bg-primary">{{ r.media_7fiadas }}</span>{% else %}<span class="text-muted">‚Äî</span>{% endif %}
              </td>
              <td class="text-center">
                {% if r.media_alicerce != '-' %}<span class="badge bg-secondary">{{ r.media_alicerce }}</span>{% else %}<span class="text-muted">‚Äî</span>{% endif %}
              </td>
              <td class="text-center">
                {% if r.media_platibanda != '-' %}<span class="badge bg-info text-dark">{{ r.media_platibanda }}</span>{% else %}<span class="text-muted">‚Äî</span>{% endif %}
              </td>
              <td class="text-center">
                {% if r.media_reboco_ext != '-' %}<span class="badge bg-warning text-dark">{{ r.media_reboco_ext }}</span>{% else %}<span class="text-muted">‚Äî</span>{% endif %}
              </td>
              <td class="text-center border-end">
                {% if r.media_reboco_int != '-' %}<span class="badge bg-success">{{ r.media_reboco_int }}</span>{% else %}<span class="text-muted">‚Äî</span>{% endif %}
              </td>
              <td class="text-center">{{ r.total_dias }}</td>
              <td class="text-center">
                {% if r.total_ociosidade > 0 %}
                  <span class="text-warning fw-bold">{{ r.total_ociosidade }}</span>
                {% else %}0{% endif %}
              </td>
              <td class="text-center">
                {% if r.total_retrabalho > 0 %}
                  <span class="text-danger fw-bold">{{ r.total_retrabalho }}</span>
                {% else %}0{% endif %}
              </td>
              <td class="text-center">{{ r.total_horas|floatformat:1 }}</td>
              <td class="text-center">R$ {{ r.total_valor|floatformat:2 }}</td>
              <td class="text-center">{{ r.total_metragem|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="12" class="text-muted text-center">Sem dados</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SE√á√ÉO 4: Apontamentos Detalhados            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card section-card shadow-sm mb-4">
    <div class="card-header bg-white border-0 pt-3">
      <h5 class="mb-0"><i class="bi bi-journal-text text-secondary"></i> 4. Apontamentos do Per√≠odo</h5>
      <small class="text-muted">Mostra o que foi preenchido no dia (ociosidade, retrabalho e observa√ß√µes)</small>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Data</th>
              <th>Funcion√°rio</th>
              <th>Obra</th>
              <th>Etapa</th>
              <th class="text-center">Ociosidade</th>
              <th>Obs. Ociosidade</th>
              <th class="text-center">Retrabalho</th>
              <th>Motivo Retrabalho</th>
              <th>Observa√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for a in apontamentos_periodo %}
            <tr>
              <td>{{ a.data|date:'d/m/Y' }}</td>
              <td class="fw-semibold">{{ a.funcionario.nome_completo }}</td>
              <td>{{ a.obra.nome }}</td>
              <td>{% if a.etapa %}{{ a.etapa }}{% else %}-{% endif %}</td>
              <td class="text-center">
                {% if a.houve_ociosidade %}
                  <span class="badge bg-warning text-dark">Sim</span>
                {% else %}
                  <span class="text-muted">N√£o</span>
                {% endif %}
              </td>
              <td>{{ a.observacao_ociosidade|default:'-' }}</td>
              <td class="text-center">
                {% if a.houve_retrabalho %}
                  <span class="badge bg-danger">Sim</span>
                {% else %}
                  <span class="text-muted">N√£o</span>
                {% endif %}
              </td>
              <td>{{ a.motivo_retrabalho|default:'-' }}</td>
              <td>{{ a.observacoes|default:'-' }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="9" class="text-muted text-center">Sem apontamentos no per√≠odo</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const obraSelect = document.getElementById('id_obra');
    const etapaSelect = document.getElementById('id_etapa');
    if (!obraSelect || !etapaSelect) return;

    const defaultOptionText = 'Todas as Etapas';

    function resetEtapas(disabled = true) {
      etapaSelect.innerHTML = '';
      const option = document.createElement('option');
      option.value = '';
      option.textContent = defaultOptionText;
      etapaSelect.appendChild(option);
      etapaSelect.disabled = disabled;
    }

    async function carregarEtapas(obraId) {
      if (!obraId) {
        resetEtapas(true);
        return;
      }

      const etapaSelecionadaAtual = etapaSelect.value;
      resetEtapas(true);

      try {
        const response = await fetch(`{% url 'relatorios:etapas_por_obra' %}?obra_id=${encodeURIComponent(obraId)}`);
        if (!response.ok) throw new Error('Erro ao carregar etapas');

        const payload = await response.json();
        const etapas = payload.etapas || [];

        etapas.forEach(function (etapa) {
          const option = document.createElement('option');
          option.value = etapa.id;
          option.textContent = etapa.nome;
          if (String(etapa.id) === String(etapaSelecionadaAtual)) {
            option.selected = true;
          }
          etapaSelect.appendChild(option);
        });

        etapaSelect.disabled = false;
      } catch (error) {
        resetEtapas(true);
      }
    }

    if (!obraSelect.value) {
      resetEtapas(true);
    } else {
      etapaSelect.disabled = false;
    }

    obraSelect.addEventListener('change', function () {
      carregarEtapas(this.value);
    });
  });
</script>
{% endblock %}
